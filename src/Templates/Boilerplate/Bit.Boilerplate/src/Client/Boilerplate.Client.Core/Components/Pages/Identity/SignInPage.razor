@*+:cnd:noEmit*@
@page "/sign-in"
@inherits AppComponentBase

<PageTitle>@Localizer[nameof(AppStrings.SignInTitle)]</PageTitle>

<div class="page-container">
    <EditForm OnValidSubmit="WrapHandled(DoSignIn)" class="form" Model="signInModel">
        <AppDataAnnotationsValidator />

        @if (string.IsNullOrEmpty(message) is false)
        {
            <BitMessageBar Class="form-message-bar"
                           MessageBarType="@messageType"
                           OnDismiss="() => message = null">
                @message
            </BitMessageBar>
        }

        <h1 class="form-title">@Localizer[nameof(AppStrings.SignInTitle)]</h1>

        @if (requiresTwoFactor is false)
        {
            <div class="form-input-container">
                <BitTextField @bind-Value="signInModel.UserName"
                              Label="@Localizer[nameof(AppStrings.Email)]"
                              Placeholder="@Localizer[nameof(AppStrings.Email)]"
                              Type="BitTextFieldType.Email" />
                <ValidationMessage For="@(() => signInModel.UserName)" />
            </div>

            <div class="form-input-container">
                <BitTextField @bind-Value="signInModel.Password"
                              Label="@Localizer[nameof(AppStrings.Password)]"
                              Type="BitTextFieldType.Password"
                              AutoComplete="current-password"
                              CanRevealPassword="true"
                              Placeholder="@Localizer[nameof(AppStrings.Password)]" />
                <ValidationMessage For="@(() => signInModel.Password)" />
            </div>

            <div class="form-input-container form-input-container--no-margin">
                <BitCheckbox Class="form-checkbox" @bind-Value="signInModel.RememberMe" Label="@Localizer[nameof(AppStrings.RememberMe)]" />
            </div>
        }
        else
        {
            <h3 class="form-title">@Localizer[nameof(AppStrings.TwoFactorAuthTitle)]</h3>

            <div>@Localizer[nameof(AppStrings.TfaProtectedSignInSubtitle)]</div>

            <br />

            <div class="form-input-container">
                <div>@Localizer[nameof(AppStrings.TfaEnterCodeInSignInMessage)]</div>
                <BitTextField @bind-Value="signInModel.TwoFactorCode"
                              Placeholder="@Localizer[nameof(AppStrings.TwoFactorCode)]" />
            </div>

            <div class="form-input-container">
                <div>@Localizer[nameof(AppStrings.TfaEnterRecoveryCodeInSignInMessage)]</div>
                <BitTextField @bind-Value="signInModel.TwoFactorRecoveryCode"
                              Placeholder="@Localizer[nameof(AppStrings.TwoFactorRecoveryCode)]" />
            </div>

            <br />

            <div class="form-input-container tfa-token-container">
                <div>@Localizer[nameof(AppStrings.TfaTokenSignInTitle)]</div>
                <BitButton Style="padding:0"
                           ButtonType="BitButtonType.Button"
                           IconName="@BitIconName.Mail"
                           IconPosition="BitButtonIconPosition.End"
                           IsLoading="isGeneratingToken"
                           OnClick="WrapHandled(SendTfaTokenEmail)">
                    @Localizer[nameof(AppStrings.TfaTokenGenerateButtonText)]
                </BitButton>
                <BitTextField @bind-Value="signInModel.TwoFactorToken"
                              Style="flex-grow:1"
                              Placeholder="@Localizer[nameof(AppStrings.TwoFactorToken)]" />
            </div>
        }

        <BitButton IsLoading="isSigningIn"
                   Class="form-submit-button"
                   ButtonStyle="BitButtonStyle.Primary"
                   Title="@Localizer[nameof(AppStrings.SignIn)]"
                   AriaLabel="@Localizer[nameof(AppStrings.SignIn)]"
                   ButtonType="BitButtonType.Submit">
            @Localizer[nameof(AppStrings.SignIn)]
        </BitButton>

        <div class="form-forgot-password">
            <BitLink Href="/forgot-password">@Localizer[nameof(AppStrings.ForgotPasswordLink)]</BitLink>
        </div>

        <div>
            @Localizer[nameof(AppStrings.DontHaveAccountMessage)] <BitLink Href="/sign-up">@Localizer[nameof(AppStrings.SignUp)]</BitLink>
        </div>
    </EditForm>
</div>
