# Stage 20: .NET Aspire

Welcome to Stage 20! In this stage, you'll learn about .NET Aspire and how it transforms both development and deployment experiences in this Boilerplate project.

---

## What is .NET Aspire?

.NET Aspire is an **opinionated, cloud-ready stack** for building observable, production-ready distributed applications. It's a developer-first, always-free, open-source platform that helps you orchestrate complex multi-service applications with ease.

### Key Philosophy

Aspire follows a **"code-centric control"** approach where you define your entire stack in type-safe and readable. You can run locally and deploy anywhere without architectural changes.

---

## How .NET Aspire Benefits This Project

.NET Aspire **significantly improves both Development and Deployment**:

### 1. **Development Experience** ğŸš€

.NET Aspire provides an **awesome dashboard for monitoring your app during development**, giving you:

- **Real-time Logs**: See all application logs in one place
- **Metrics**: Monitor performance counters and custom metrics
- **Distributed Traces**: Track requests across services
- **Health Checks**: View the health status of all services
- **Resource Management**: Access database management tools

Additionally, it provides:
- **Service Orchestration**: Automatically provisions and configures dependencies like databases, message brokers, and storage
- **Service Discovery**: Services can find and communicate with each other without hardcoding addresses
- **Built-in Development Tools**: 
  - **DbGate** for database management (in this project)
  - **MailPit** for email testing
  - **Minio** for S3-compatible storage testing
  - **Dev Tunnels** for public HTTPS URLs

### 2. **Deployment Flexibility** ğŸŒ

.NET Aspire **simplifies deployment** not only to Azure Cloud, but also to:

- âœ… **Docker Compose** (for container-based deployments on VPS and self-hosted environments)
- âœ… **Kubernetes (k8s)** (for enterprise orchestration on any provider)
- âœ… **Azure Cloud** (with automatic resource provisioning)

The same code you write for local development works across all these deployment targets!

---

## Aspire in This Project

### Project Structure

The Aspire orchestration is managed by:

**Location**: [`src/Server/Boilerplate.Server.AppHost/`](/src/Server/Boilerplate.Server.AppHost/)

This project contains:
- **`Program.cs`**: Defines all application resources and dependencies
- **`appsettings.json`**: General configuration
- **`appsettings.Development.json`**: Development-specific settings (credentials, passwords)

### AppHost Configuration

Let's explore the `Program.cs` file:

```csharp
using Microsoft.Extensions.Hosting;

var builder = DistributedApplication.CreateBuilder(args);

// Check out appsettings.Development.json for credentials/passwords settings.

var sqlDatabase = builder.AddSqlServer("sqlserver")
        .WithDbGate(config => config.WithDataVolume())  // Adds web-based DB management
        .WithDataVolume()  // Persists data across restarts
        .WithImage("mssql/server", "2025-latest")  // SQL Server 2025 with vector search
        .AddDatabase("mssqldb");

// S3-compatible storage using Minio
var s3Storage = builder.AddMinioContainer("s3")
    .WithDataVolume();  // Persists uploaded files

// Main server project
var serverWebProject = builder.AddProject("serverweb", "../Boilerplate.Server.Web/Boilerplate.Server.Web.csproj")
    .WithExternalHttpEndpoints();

// Health checks (development only for security)
if (builder.Environment.IsDevelopment())
{
    serverWebProject.WithHttpHealthCheck("/alive");
}

// Set up dependencies
serverWebProject.WithReference(sqlDatabase).WaitFor(sqlDatabase);
serverWebProject.WithReference(s3Storage);

// Testing projects (run mode only)
if (builder.ExecutionContext.IsRunMode)
{
    // Blazor WebAssembly Standalone
    builder.AddProject("clientwebwasm", "../../Client/Boilerplate.Client.Web/Boilerplate.Client.Web.csproj")
        .WithExplicitStart();

    // Email testing with Mailpit (for testing purposes only)
    var mailpit = builder.AddMailPit("smtp")
        .WithDataVolume("mailpit");
    serverWebProject.WithReference(mailpit);

    // Blazor Hybrid Windows
    builder.AddProject("clientwindows", "../../Client/Boilerplate.Client.Windows/Boilerplate.Client.Windows.csproj")
        .WithExplicitStart();

    // Dev Tunnel for public HTTPS access
    var tunnel = builder.AddDevTunnel("web-dev-tunnel")
        .WithAnonymousAccess()
        .WithReference(serverWebProject.WithHttpEndpoint(name: "devTunnel").GetEndpoint("devTunnel"));
}

await builder.Build().RunAsync();
```

### Key Features in This Configuration

1. **SQL Server 2025**: Uses the latest SQL Server with embedded vector search capabilities
2. **DbGate Integration**: Web-based database management UI accessible during development
3. **Data Volumes**: All data persists across container restarts
4. **Service Dependencies**: `serverWebProject.WaitFor(sqlDatabase)` ensures database is ready before server starts
5. **Conditional Services**: Email testing and client projects only in development mode
6. **Dev Tunnels**: Allows external access to your local development server via HTTPS

---

## The Aspire Dashboard

### What is the Aspire Dashboard?

The Aspire Dashboard is a **built-in OpenTelemetry-powered monitoring interface** that provides:

- ğŸ“Š **Real-time Logs**: See all application logs in one place
- ğŸ“ˆ **Metrics**: Monitor performance counters and custom metrics
- ğŸ” **Distributed Traces**: Track requests across services
- â¤ï¸ **Health Checks**: View the health status of all services
- ğŸ—„ï¸ **Resource Management**: Access database management tools

### How to Access the Dashboard

When you run the AppHost project, the dashboard automatically opens in your browser. You'll see:

1. **Resources Tab**: All services, databases, and containers
2. **Console Logs Tab**: Combined output from all services
3. **Structured Logs Tab**: Searchable, filterable logs with context
4. **Traces Tab**: Distributed tracing across service boundaries
5. **Metrics Tab**: Performance metrics and custom counters

### Dashboard Benefits

âœ… **Centralized Monitoring**: Single interface for all application components  
âœ… **Immediate Debugging**: Quickly identify issues with detailed logs and traces  
âœ… **No Configuration Required**: Everything works out of the box  
âœ… **Production-Ready Patterns**: Same observability patterns used in production

---

## Learning Resources

### Official Documentation

To learn more about .NET Aspire capabilities, visit:

ğŸ”— **https://aspire.dev**

The official documentation covers:
- Getting started guides
- Integration gallery (databases, message brokers, cloud services)
- Deployment guides
- Best practices

---

## Important Database Management Tip

### The Challenge

There's one important detail that might take time to discover:

When the application is running, you can manage the database through **Aspire's built-in DbGate** web-based database management tool.

**However**, when the application stops:
- âŒ The database stops
- âŒ DbGate stops working
- âŒ You can't even connect with external tools (SSMS, Azure Data Studio, etc.)

This is fine for test projects, but for **real projects** where you continuously work with the database, this can be limiting.

### The Solution: Persistent Database Configuration

To keep the database **running persistently** (even when the app stops):

1. Open `Program.cs` in the `Boilerplate.Server.AppHost` project
2. Add the following configurations to your database setup:

```csharp
var sqlDatabase = builder.AddSqlServer("sqlserver", port: ?????)
    .WithDbGate(config => config.WithDataVolume())
    .WithDataVolume()
    .WithImage("mssql/server", "2025-latest")
    // ğŸ”‘ Add these two lines for persistence:
    .WithLifetime(ContainerLifetime.Persistent)  // âœ… Keeps running when app stops
    .WithEndpointProxySupport(proxyEnabled: false)  // âœ… Direct port access
    .AddDatabase("mssqldb");
```

### Result

âœ… Database remains running even when the app stops  
âœ… Connect with any database tool (SSMS, Azure Data Studio, DBeaver, etc.)  
âœ… Use the specified port (e.g., `localhost,1433`)  
âœ… Credentials are stored in `appsettings.Development.json`

### Finding Database Credentials

**Location**: [`src/Server/Boilerplate.Server.AppHost/appsettings.Development.json`](/src/Server/Boilerplate.Server.AppHost/appsettings.Development.json)

```json
{
    "Parameters": {
        "sqlserver-password": "P@ssw0rd",
        "sqlserver__Comment": "The username is `sa` by default",
        "s3-rootPassword": "P@ssw0rd",
        "s3__Comment": "The username is `minioadmin` by default",
        "Comment": "You might need to delete the docker volumes to apply changes to the passwords"
    }
}
```

**Default SQL Server Credentials**:
- **Username**: `sa`
- **Password**: `P@ssw0rd` (configurable)
- **Server**: `localhost,1433` (or your configured port)

---

## Important Note: Docker Execution

### How This Project Uses Docker

**For Performance Optimization**:
- âŒ `Boilerplate.Server.Api` **does NOT** run on Docker
- âŒ `Boilerplate.Server.Web` **does NOT** run on Docker
- âœ… They run **natively** for faster development experience

**Why?**
- Native execution is significantly faster than containers
- Hot reload and debugging work better
- Less resource consumption on your development machine

### Testing Linux Behavior on Windows

If you want to **test server behavior in Linux** while **still using Aspire** on Windows:

1. Open the project in **Visual Studio Code**
2. Use **Dev Containers** feature (requires Docker Desktop and Dev Containers extension)
3. Run this command in the terminal to clean previous Windows build artifacts:
   ```bash
   chmod +x ./Clean.sh && ./Clean.sh
   ```
4. Then run the `Boilerplate.Server.AppHost` project

**Result**: You can test Linux behavior while still benefiting from Aspire's features! ğŸ§

---

## Aspire Packages Used

This project uses several Aspire hosting packages:

### Official Aspire Packages

```xml
<PackageReference Include="Aspire.Hosting.AppHost" />
<PackageReference Include="Aspire.Hosting.DevTunnels" />
<PackageReference Include="Aspire.Hosting.SqlServer" />
```

### Community Toolkit Extensions

```xml
<PackageReference Include="CommunityToolkit.Aspire.Hosting.MailPit" />
<PackageReference Include="CommunityToolkit.Aspire.Hosting.SqlServer.Extensions" />
<PackageReference Include="CommunityToolkit.Aspire.Hosting.Minio" />
```

These packages provide:
- **MailPit**: Email testing interface
- **DbGate**: Database management UI
- **Minio**: S3-compatible storage
- **Dev Tunnels**: Public HTTPS URLs for testing

---

## Deployment with Aspire

### Supported Deployment Targets

.NET Aspire simplifies deployment to:

1. **Azure Cloud**
   - Automatic resource provisioning
   - Azure Container Apps
   - Azure SQL Database
   - Azure Blob Storage

2. **Docker Compose**
   - Generate `docker-compose.yml` automatically
   - Perfect for VPS and self-hosted environments

3. **Kubernetes (k8s)**
   - Generate Kubernetes manifests
   - Works with any k8s provider (Azure AKS, AWS EKS, Google GKE, on-premises)

### How Deployment Works

Aspire can generate deployment artifacts for these platforms based on your `Program.cs` configuration. The same code that orchestrates local development can be transformed into:

- Azure Bicep templates
- Docker Compose files
- Kubernetes YAML manifests

This ensures **consistency** between development and production environments!

---

## Additional Resources

- ğŸ“š **Official Documentation**: https://aspire.dev
- ğŸ¯ **Integration Gallery**: https://aspire.dev/integrations/gallery/
- ğŸš€ **Getting Started**: https://aspire.dev/get-started/welcome/
- ğŸ“¦ **Community Toolkit**: https://github.com/CommunityToolkit/Aspire
- ğŸ’¬ **Discord Community**: https://discord.com/invite/raNPcaaSj8

---
