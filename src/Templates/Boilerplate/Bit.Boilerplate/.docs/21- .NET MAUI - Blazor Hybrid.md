# Stage 21: .NET MAUI - Blazor Hybrid

Welcome to Stage 21! In this stage, you will learn about the `.NET MAUI Blazor Hybrid` architecture in the project, which enables you to build native cross-platform applications for Android, iOS, Windows, and macOS using Blazor and C#.

---

## Table of Contents
1. [Overview](#overview)
2. [Platform Support](#platform-support)
3. [Project Structure](#project-structure)
4. [MauiProgram.cs - Application Entry Point](#mauiprogramcs---application-entry-point)
5. [MauiProgram.Services.cs - Service Registration](#mauiprogramservicescs---service-registration)
6. [Platform-Specific Code](#platform-specific-code)
7. [Deep Links (Android) and Universal Links (iOS)](#deep-links-android-and-universal-links-ios)
8. [BlazorWebView Customization](#blazorwebview-customization)
9. [Native Capabilities Access](#native-capabilities-access)
10. [App Versioning](#app-versioning)
11. [Performance Optimizations](#performance-optimizations)
12. [MAUI-Specific Pages and Components](#maui-specific-pages-and-components)
13. [Key Benefits and Differences from Web](#key-benefits-and-differences-from-web)
14. [Running the MAUI Project](#running-the-maui-project)

---

## Overview

The `Boilerplate.Client.Maui` project provides **native application outputs** for Android, iOS, macOS, and Windows with full access to operating system features.

### Key Benefits:
- **Better Performance**: Native apps typically perform better than their web counterparts
- **Broader Reach**: Distribute your app through Google Play Store, Apple App Store, and Microsoft Store
- **Full Native Capabilities**: Access device features, local TCP connections, file system, sensors, camera, notifications, and more
- **Code Compatibility**: Most code that works in the web version will work in MAUI, with some platform-specific considerations
- **Single Codebase**: Share 95%+ of your code across all platforms via the `Boilerplate.Client.Core` project

### Supported Platforms & Versions
For the most up-to-date information on supported platforms, browsers, and OS versions, refer to:
**https://bitplatform.dev/templates**

Current support includes:
- **Android**: Version 8+ with WebView 85+
- **iOS**: Version 15+
- **Windows**: Windows 7 SP1+, 8, 10, and 11
- **macOS**: Monterey 12+

---

## Platform Support

The `Boilerplate.Client.Maui.csproj` file multi-targets several platforms:

**Location**: [/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj](/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj)

```xml
<PropertyGroup>
    <TargetFrameworks>net10.0-android;net10.0-ios;net10.0-maccatalyst</TargetFrameworks>
    <TargetFrameworks Condition="$([MSBuild]::IsOSPlatform('windows'))">$(TargetFrameworks);net10.0-windows10.0.19041.0</TargetFrameworks>
    <TargetFrameworks Condition="$([MSBuild]::IsOSPlatform('linux'))">net10.0-android</TargetFrameworks>
    <OutputType>Exe</OutputType>
    <UseMaui>true</UseMaui>
    <SingleProject>true</SingleProject>
    
    <ApplicationTitle>Boilerplate</ApplicationTitle>
    <ApplicationId>com.bitplatform.template</ApplicationId>
</PropertyGroup>
```

**Important Properties**:
- `TargetFrameworks`: Defines which platforms the app can build for
- `ApplicationId`: The unique identifier for your app (e.g., `com.yourcompany.yourapp`)
- `ApplicationTitle`: The display name of your app
- `SingleProject`: Enables MAUI's single-project architecture (all platforms in one project)

---

## Project Structure

The MAUI project follows a well-organized structure:

```
Boilerplate.Client.Maui/
├── App.xaml                          # MAUI Application definition
├── App.xaml.cs                       # Application initialization
├── MainPage.xaml                     # Main page hosting BlazorWebView
├── MainPage.xaml.cs
├── MauiProgram.cs                    # Entry point and configuration
├── MauiProgram.Services.cs           # Service registration
├── ClientMauiSettings.cs             # MAUI-specific settings
├── appsettings.json                  # Configuration
├── appsettings.Development.json
├── appsettings.Production.json
├── Components/                       # MAUI-specific components
│   └── Pages/
│       ├── AboutPage.razor           # Example platform-specific page
│       └── AboutPage.razor.cs
├── Platforms/                        # Platform-specific code
│   ├── Android/
│   │   ├── MainActivity.cs           # Android entry point
│   │   ├── MainApplication.cs        # Application setup
│   │   ├── AndroidManifest.xml       # Android permissions & config
│   │   └── Resources/
│   ├── iOS/
│   │   ├── AppDelegate.cs            # iOS application delegate
│   │   ├── Program.cs                # iOS entry point
│   │   ├── Info.plist                # iOS capabilities & permissions
│   │   └── Entitlements.Production.plist  # iOS entitlements
│   ├── MacCatalyst/
│   │   ├── AppDelegate.cs
│   │   ├── Info.plist
│   │   └── Entitlements.Production.plist
│   ├── Windows/
│   │   ├── App.xaml                  # Windows app definition
│   │   └── Package.appxmanifest      # Windows app manifest
│   └── Tizen/                        # (Optional, commented out by default)
├── Services/                         # MAUI-specific service implementations
│   ├── MauiExceptionHandler.cs
│   ├── MauiStorageService.cs
│   ├── MauiAppUpdateService.cs
│   ├── MauiDeviceCoordinator.cs
│   ├── MauiExternalNavigationService.cs
│   ├── MauiLocalHttpServer.cs
│   ├── MauiTelemetryContext.cs
│   └── MauiWebAuthnService.cs
└── wwwroot/                          # Static web assets
```

---

## MauiProgram.cs - Application Entry Point

The `MauiProgram.cs` file is the heart of the MAUI application configuration.

**Location**: [/src/Client/Boilerplate.Client.Maui/MauiProgram.cs](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs)

### Key Responsibilities:

1. **Global Exception Handling**
```csharp
AppDomain.CurrentDomain.UnhandledException += (_, e) => 
    LogException(e.ExceptionObject, reportedBy: nameof(AppDomain.UnhandledException));

TaskScheduler.UnobservedTaskException += (_, e) =>
{
    LogException(e.Exception, nameof(TaskScheduler.UnobservedTaskException));
    e.SetObserved();
};
```

2. **Platform Detection**
```csharp
AppPlatform.IsBlazorHybrid = true;
#if iOS
AppPlatform.IsIosOnMacOS = NSProcessInfo.ProcessInfo.IsiOSApplicationOnMac;
#endif
```

3. **MAUI App Builder Configuration**
```csharp
var builder = MauiApp.CreateBuilder();

builder
    .UseMauiApp<App>()
    .UseAppStoreInfo()  // Adds app store information services
    .UseSentry(options => /* ... */)  // Error reporting (if enabled)
    .Configuration.AddClientConfigurations(clientEntryAssemblyName: "Boilerplate.Client.Maui");
```

4. **Local Notifications Setup** (if enabled)
```csharp
if (AppPlatform.IsWindows is false)
{
    builder.UseLocalNotification();
}
```

5. **Service Registration**
```csharp
builder.ConfigureServices();  // Calls MauiProgram.Services.cs
```

6. **Lifecycle Events Configuration**
```csharp
builder.ConfigureLifecycleEvents(lifecycle =>
{
#if iOS || Mac
    lifecycle.AddiOS(ios =>
    {
        // Handle universal links (deep linking)
        bool HandleAppLink(NSUserActivity? userActivity)
        {
            if (userActivity?.WebPageUrl is not null)
            {
                var url = $"{userActivity.WebPageUrl.Path}?{userActivity.WebPageUrl.Query}";
                _ = Core.Components.Routes.OpenUniversalLink(url);
                return true;
            }
            return false;
        }

        ios.FinishedLaunching((app, data) => HandleAppLink(app.UserActivity));
        ios.ContinueUserActivity((app, userActivity, handler) => HandleAppLink(userActivity));
    });
#endif
});
```

7. **BlazorWebView Setup**
```csharp
SetupBlazorWebView();  // Customizes the WebView for each platform
```

8. **Dynamic Page Title Updates**
```csharp
mauiApp.Services.GetRequiredService<PubSubService>()
    .Subscribe(ClientPubSubMessages.PAGE_DATA_CHANGED, async (args) =>
    {
        var (title, _, __) = ((string?, string?, bool))args!;
        await MainThread.InvokeOnMainThreadAsync(() =>
        {
            Application.Current!.Windows.First().Title = title ?? "Boilerplate";
        });
    });
```

---

## MauiProgram.Services.cs - Service Registration

The `MauiProgram.Services.cs` file contains all service registrations for the MAUI application.

**Location**: [/src/Client/Boilerplate.Client.Maui/MauiProgram.Services.cs](/src/Client/Boilerplate.Client.Maui/MauiProgram.Services.cs)

### Service Registration Pattern:

```csharp
public static void ConfigureServices(this MauiAppBuilder builder)
{
    var services = builder.Services;
    var configuration = builder.Configuration;
    
    // 1. Register shared Client.Core services
    services.AddClientCoreProjectServices(builder.Configuration);
    
    // 2. Register MAUI-specific pages
    services.AddTransient<MainPage>();
    
    // 3. Override Client.Core services with MAUI implementations
    services.AddScoped<IWebAuthnService, MauiWebAuthnService>();
    services.AddScoped<IExceptionHandler, MauiExceptionHandler>();
    services.AddScoped<IAppUpdateService, MauiAppUpdateService>();
    services.AddScoped<IBitDeviceCoordinator, MauiDeviceCoordinator>();
    services.AddScoped<IExternalNavigationService, MauiExternalNavigationService>();
    
    // 4. Configure HttpClient with base address
    services.AddScoped<HttpClient>(sp =>
    {
        var handlerFactory = sp.GetRequiredService<HttpMessageHandlersChainFactory>();
        var httpClient = new HttpClient(handlerFactory.Invoke())
        {
            BaseAddress = new Uri(configuration.GetServerAddress(), UriKind.Absolute)
        };
        if (sp.GetRequiredService<ClientMauiSettings>().WebAppUrl is Uri origin)
        {
            httpClient.DefaultRequestHeaders.Add("X-Origin", origin.ToString());
        }
        return httpClient;
    });
    
    // 5. Register platform-specific storage
    services.AddSingleton<IStorageService, MauiStorageService>();
    
    // 6. Register settings
    services.AddSingleton(ITelemetryContext.Current!);
    services.AddSingleton<ILocalHttpServer, MauiLocalHttpServer>();
    
    // 7. Add BlazorWebView
    services.AddMauiBlazorWebView();
    services.AddBlazorWebViewDeveloperTools();
    
    // 8. Configure logging
    builder.Logging.ConfigureLoggers(configuration);
    builder.Logging.AddEventSourceLogger();
    
    if (AppPlatform.IsWindows)
    {
        builder.Logging.AddEventLog(options => 
            configuration.GetRequiredSection("Logging:EventLog").Bind(options));
    }
    
    // 9. Add Application Insights (if enabled)
    if (string.IsNullOrEmpty(settings.ApplicationInsights?.ConnectionString) is false)
    {
        builder.Logging.AddApplicationInsights(config =>
        {
            config.TelemetryInitializers.Add(new MauiAppInsightsTelemetryInitializer());
            configuration.GetRequiredSection("ApplicationInsights").Bind(config);
        });
    }
    
    // 10. Platform-specific service registration
#if Android
    services.AddClientMauiProjectAndroidServices(builder.Configuration);
#elif iOS
    services.AddClientMauiProjectIosServices(builder.Configuration);
#elif Mac
    services.AddClientMauiProjectMacCatalystServices(builder.Configuration);
#elif Windows
    services.AddClientMauiProjectWindowsServices(builder.Configuration);
#endif
}
```

### Key Points:
- **Service Override Pattern**: MAUI-specific implementations (e.g., `MauiStorageService`) override the generic implementations from `Client.Core`
- **Platform-Specific Services**: Each platform can have its own service implementations via conditional compilation
- **Shared Core**: The `AddClientCoreProjectServices()` call registers all shared services, ensuring consistency across platforms

---

## Platform-Specific Code

Each platform has its own folder under `Platforms/` containing platform-specific initialization and configuration.

### Android Platform

**Entry Point**: [/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs)

```csharp
[Activity(Theme = "@style/Maui.SplashTheme", MainLauncher = true, LaunchMode = LaunchMode.SingleTask,
    ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation | 
                          ConfigChanges.UiMode | ConfigChanges.ScreenLayout | 
                          ConfigChanges.SmallestScreenSize | ConfigChanges.Density)]
public partial class MainActivity : MauiAppCompatActivity
{
    protected override void OnCreate(Bundle? savedInstanceState)
    {
        Theme?.ApplyStyle(Resource.Style.OptOutEdgeToEdgeEnforcement, force: false);
        base.OnCreate(savedInstanceState);
        
        // Handle deep links when app was closed
        var url = Intent?.DataString;
        if (string.IsNullOrWhiteSpace(url) is false)
        {
            _ = Routes.OpenUniversalLink(new URL(url).File ?? PageUrls.Home);
        }
        
        // Setup push notifications (if enabled)
        // ...
    }
    
    protected override void OnNewIntent(Intent? intent)
    {
        base.OnNewIntent(intent);
        
        // Handle deep links when app is running
        var url = intent?.DataString;
        if (!string.IsNullOrWhiteSpace(url))
        {
            _ = Routes.OpenUniversalLink(new URL(url).File ?? PageUrls.Home);
        }
    }
}
```

**Permissions**: [/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainApplication.cs](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainApplication.cs)

```csharp
[assembly: UsesPermission(Android.Manifest.Permission.Internet)]
[assembly: UsesPermission(Android.Manifest.Permission.AccessNetworkState)]

// If notifications are enabled:
[assembly: UsesPermission(Android.Manifest.Permission.PostNotifications)]
[assembly: UsesPermission(Android.Manifest.Permission.Vibrate)]
[assembly: UsesPermission(Android.Manifest.Permission.WakeLock)]
```

### iOS Platform

**Entry Point**: [/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Program.cs](/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Program.cs)

```csharp
public partial class Program
{
    static void Main(string[] args)
    {
        UIApplication.Main(args, null, typeof(AppDelegate));
    }
}
```

**Capabilities**: [/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Info.plist](/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Info.plist)

```xml
<key>NSCameraUsageDescription</key>
<string>This app uses camera for uploading profile photo using FileUpload component</string>

<key>UISupportedInterfaceOrientations</key>
<array>
    <string>UIInterfaceOrientationPortrait</string>
    <string>UIInterfaceOrientationLandscapeLeft</string>
    <string>UIInterfaceOrientationLandscapeRight</string>
</array>

<!-- If notifications are enabled: -->
<key>UIBackgroundModes</key>
<array>
    <string>fetch</string>
    <string>remote-notification</string>
</array>
```

### Windows Platform

**Entry Point**: [/src/Client/Boilerplate.Client.Maui/Platforms/Windows/App.xaml.cs](/src/Client/Boilerplate.Client.Maui/Platforms/Windows/App.xaml.cs)

```csharp
public partial class App
{
    public App()
    {
        InitializeComponent();
    }

    protected override MauiApp CreateMauiApp() => MauiProgram.CreateMauiApp();
}
```

### macOS (Mac Catalyst) Platform

Similar to iOS, but with macOS-specific configurations in `Platforms/MacCatalyst/`.

---

## Deep Links (Android) and Universal Links (iOS)

Deep links allow users to open specific pages in your app directly from web URLs. This is crucial for:
- Email verification links
- Password reset links
- Sharing specific content
- Marketing campaigns

### Android Deep Links Configuration

**Location**: [/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs)

```csharp
[IntentFilter([Intent.ActionView],
    DataSchemes = ["https", "http"],
    DataHosts = ["use-your-web-app-url-here.com"],  // ⚠️ Replace with your domain
    DataPaths = [PageUrls.Home],
    DataPathPrefixes = [
        "/en-US", "/en-GB", "/nl-NL", "/fa-IR", "sv-SE", "hi-IN", "zh-CN",
        PageUrls.Confirm, PageUrls.ForgotPassword, PageUrls.Settings,
        PageUrls.ResetPassword, PageUrls.SignIn, PageUrls.SignUp,
        // Add more paths as needed
    ],
    AutoVerify = true,  // Enables Android App Links
    Categories = [Intent.ActionView, Intent.CategoryDefault, Intent.CategoryBrowsable])]
```

**How It Works**:
1. When a user clicks a link like `https://yourapp.com/confirm?token=123` on their Android device
2. If your app is installed, Android checks if your app is verified to handle this domain
3. The link opens in your app instead of the browser
4. The `MainActivity.OnCreate()` or `OnNewIntent()` methods handle the URL
5. The app navigates to the appropriate page using `Routes.OpenUniversalLink()`

**Android App Links Verification**:
- Set `AutoVerify = true` in the `IntentFilter`
- Host a `.well-known/assetlinks.json` file on your website
- This file proves you own both the website and the app

### iOS Universal Links Configuration

**Location**: [/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Entitlements.Production.plist](/src/Client/Boilerplate.Client.Maui/Platforms/iOS/Entitlements.Production.plist)

```xml
<dict>
    <key>com.apple.developer.associated-domains</key>
    <array>
        <string>applinks:use-your-web-app-url-here.com</string>  <!-- ⚠️ Replace with your domain -->
    </array>
</dict>
```

**How It Works**:
1. Add your domain to the entitlements file with the `applinks:` prefix
2. Host an Apple App Site Association (AASA) file at `https://yourapp.com/.well-known/apple-app-site-association`
3. When a user taps a link to your domain, iOS checks for the AASA file
4. If verified, the link opens in your app
5. The app handles the link via lifecycle events in `MauiProgram.cs`:

```csharp
lifecycle.AddiOS(ios =>
{
    bool HandleAppLink(NSUserActivity? userActivity)
    {
        if (userActivity is not null && 
            userActivity.ActivityType == NSUserActivityType.BrowsingWeb && 
            userActivity.WebPageUrl is not null)
        {
            var url = $"{userActivity.WebPageUrl.Path}?{userActivity.WebPageUrl.Query}";
            _ = Core.Components.Routes.OpenUniversalLink(url);
            return true;
        }
        return false;
    }

    ios.FinishedLaunching((app, data) => HandleAppLink(app.UserActivity));
    ios.ContinueUserActivity((app, userActivity, handler) => HandleAppLink(userActivity));
    
    // iOS 13+ scene-based handling
    if (OperatingSystem.IsIOSVersionAtLeast(13))
    {
        ios.SceneWillConnect((scene, sceneSession, sceneConnectionOptions)
            => HandleAppLink(sceneConnectionOptions.UserActivities.ToArray()
                .FirstOrDefault(a => a.ActivityType == NSUserActivityType.BrowsingWeb)));
        
        ios.SceneContinueUserActivity((scene, userActivity)
            => HandleAppLink(userActivity));
    }
});
```

### Setting Up Deep Links - Step by Step

**Step 1**: Replace the placeholder domain in your code
- Android: Update `DataHosts` in `MainActivity.cs`
- iOS: Update `Entitlements.Production.plist` and `Entitlements.Development.plist`

**Step 2**: Create the verification files on your web server

**For Android** - Create `/.well-known/assetlinks.json`:
```json
[{
  "relation": ["delegate_permission/common.handle_all_urls"],
  "target": {
    "namespace": "android_app",
    "package_name": "com.bitplatform.template",
    "sha256_cert_fingerprints": ["YOUR_SIGNING_KEY_SHA256"]
  }
}]
```

**For iOS** - Create `/.well-known/apple-app-site-association` (no file extension):
```json
{
  "applinks": {
    "apps": [],
    "details": [
      {
        "appID": "TEAM_ID.com.bitplatform.template",
        "paths": ["*"]
      }
    ]
  }
}
```

**Step 3**: Test your deep links
- Android: Use `adb shell am start -a android.intent.action.VIEW -d "https://yourapp.com/confirm"`
- iOS: Send yourself an iMessage with the link and tap it

---

## BlazorWebView Customization

The `SetupBlazorWebView()` method in `MauiProgram.cs` customizes the underlying WebView for each platform.

**Location**: [/src/Client/Boilerplate.Client.Maui/MauiProgram.cs](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs)

```csharp
private static void SetupBlazorWebView()
{
    BlazorWebViewHandler.BlazorWebViewMapper.AppendToMapping("CustomBlazorWebViewMapper", 
        static (handler, view) =>
    {
        var webView = handler.PlatformView;
        var webViewBackgroundColor = AppInfo.Current.RequestedTheme == AppTheme.Dark ?
            ThemeColors.PrimaryDarkBgColor : ThemeColors.PrimaryLightBgColor;

#if Windows
        webView.DefaultBackgroundColor = Color.FromArgb(webViewBackgroundColor).ToWindowsColor();

        webView.EnsureCoreWebView2Async()
            .AsTask()
            .ContinueWith(async _ =>
            {
                await Application.Current!.Dispatcher.DispatchAsync(() =>
                {
                    // Allow all permissions (camera, microphone, geolocation, etc.)
                    webView.CoreWebView2.PermissionRequested += async (sender, args) =>
                    {
                        args.Handled = true;
                        args.State = CoreWebView2PermissionState.Allow;
                    };
                    
                    if (AppEnvironment.IsDevelopment() is false)
                    {
                        var settings = webView.CoreWebView2.Settings;
                        settings.IsZoomControlEnabled = false;
                        settings.AreBrowserAcceleratorKeysEnabled = false;
                    }
                });
            });

#elif iOS || Mac
        webView.NavigationDelegate = new CustomWKNavigationDelegate();
        webView.Configuration.AllowsInlineMediaPlayback = true;

        webView.BackgroundColor = UIColor.Clear;
        webView.ScrollView.Bounces = false;
        webView.Opaque = false;

        // Enable Safari Web Inspector for debugging
        if ((DeviceInfo.Current.Platform == DevicePlatform.MacCatalyst && 
             DeviceInfo.Current.Version >= new Version(13, 3)) ||
            (DeviceInfo.Current.Platform == DevicePlatform.iOS && 
             DeviceInfo.Current.Version >= new Version(16, 4)))
        {
            webView.SetValueForKey(NSObject.FromObject(true), new NSString("inspectable"));
        }

#elif Android
        webView.SetBackgroundColor(Android.Graphics.Color.ParseColor(webViewBackgroundColor));

        webView.OverScrollMode = Android.Views.OverScrollMode.Never;
        webView.HapticFeedbackEnabled = false;

        Android.Webkit.WebSettings settings = webView.Settings;

        // Enable necessary WebView features
        settings.AllowFileAccessFromFileURLs =
            settings.AllowUniversalAccessFromFileURLs =
            settings.AllowContentAccess =
            settings.AllowFileAccess =
            settings.DatabaseEnabled =
            settings.JavaScriptCanOpenWindowsAutomatically =
            settings.DomStorageEnabled = true;

        if (AppEnvironment.IsDevelopment())
        {
            settings.MixedContentMode = Android.Webkit.MixedContentHandling.AlwaysAllow;
        }

        settings.BlockNetworkLoads = settings.BlockNetworkImage = false;
#endif
    });

    // Improve Android performance with async JavaScript execution
    AppContext.SetSwitch("BlazorWebView.AndroidFireAndForgetAsync", isEnabled: true);
}
```

### iOS/Mac Custom Navigation Delegate

```csharp
#if iOS || Mac
public partial class CustomWKNavigationDelegate : WKNavigationDelegate
{
    public override void DecidePolicy(WKWebView webView, WKNavigationAction navigationAction, 
        WKWebpagePreferences preferences, 
        Action<WKNavigationActionPolicy, WKWebpagePreferences> decisionHandler)
    {
        if (navigationAction.NavigationType is WKNavigationType.LinkActivated)
        {
            // Open external links in Safari, not in the WebView
            _ = Browser.OpenAsync(navigationAction.Request.Url!);
            decisionHandler.Invoke(WKNavigationActionPolicy.Cancel, preferences);
        }
        else
        {
            // Allow navigation for app content and elements like reCAPTCHA
            decisionHandler.Invoke(WKNavigationActionPolicy.Allow, preferences);
        }
    }
}
#endif
```

**Why This Matters**:
- **Permissions**: WebViews need explicit permission to access camera, microphone, geolocation, etc.
- **Performance**: Platform-specific optimizations ensure smooth scrolling and rendering
- **Developer Experience**: Enabling Web Inspector on iOS/Mac allows debugging in Safari's Developer Tools
- **User Experience**: Custom navigation ensures external links open in the system browser, not in-app

---

## Native Capabilities Access

One of the biggest advantages of MAUI Blazor Hybrid is **full access to native platform APIs** and third-party native libraries.

### Example: Accessing Native APIs

**Location**: [/src/Client/Boilerplate.Client.Maui/Components/Pages/AboutPage.razor.cs](/src/Client/Boilerplate.Client.Maui/Components/Pages/AboutPage.razor.cs)

```csharp
protected override async Task OnInitAsync()
{
    await base.OnInitAsync();

    // MAUI provides cross-platform abstractions
    appName = AppInfo.Name;
    oem = DeviceInfo.Current.Manufacturer;
    platform = telemetryContext.Platform!;
    appVersion = telemetryContext.AppVersion!;
    
    // Platform-specific code using conditional compilation
    if (AppPlatform.IsAndroid)
    {
#if Android
        // Direct access to Android APIs
        var packageManager = Platform.CurrentActivity!.PackageManager;
        var packageInfo = packageManager!.GetPackageInfo(AppInfo.PackageName, 
            default(Android.Content.PM.PackageInfoFlags));
        appVersion += " / " + packageInfo!.VersionCode;
#endif
    }
    
    processId = Environment.ProcessId.ToString();
}
```

### Categories of Native Access

#### 1. **MAUI Cross-Platform Abstractions**
These work across all platforms without conditional compilation:

```csharp
// Device information
DeviceInfo.Current.Manufacturer   // "Samsung", "Apple", "Microsoft"
DeviceInfo.Current.Model          // "Pixel 6", "iPhone 14"
DeviceInfo.Current.Platform       // Android, iOS, Windows, macOS
DeviceInfo.Current.Version        // OS version

// App information
AppInfo.Name                      // "Boilerplate"
AppInfo.PackageName              // "com.bitplatform.template"
AppInfo.Version                  // "1.0.0"
AppInfo.Build                    // "1"

// Display information
DeviceDisplay.Current.MainDisplayInfo.Width
DeviceDisplay.Current.MainDisplayInfo.Height
DeviceDisplay.Current.MainDisplayInfo.Density

// Battery
Battery.Current.ChargeLevel      // 0.0 to 1.0
Battery.Current.State           // Charging, Discharging, Full

// Connectivity
Connectivity.Current.NetworkAccess   // Internet, ConstrainedInternet, Local, None

// File system
FileSystem.AppDataDirectory      // App's private data directory
FileSystem.CacheDirectory        // Cache directory

// Preferences (key-value storage)
Preferences.Set("key", "value");
Preferences.Get("key", "default");

// Secure storage
await SecureStorage.SetAsync("token", "secretValue");
await SecureStorage.GetAsync("token");

// Geolocation
var location = await Geolocation.GetLocationAsync();
Console.WriteLine($"Lat: {location.Latitude}, Long: {location.Longitude}");

// Media picker
var photo = await MediaPicker.PickPhotoAsync();
var video = await MediaPicker.CaptureVideoAsync();

// Browser
await Browser.OpenAsync("https://bitplatform.dev");

// Email
await Email.ComposeAsync(new EmailMessage
{
    Subject = "Hello",
    Body = "World",
    To = new[] { "example@example.com" }
});

// SMS
await Sms.ComposeAsync(new SmsMessage("Hello!", "+1234567890"));

// Share
await Share.RequestAsync(new ShareTextRequest
{
    Text = "Check out this app!",
    Title = "Share App"
});
```

#### 2. **Platform-Specific APIs**
Use conditional compilation for platform-specific code:

```csharp
#if Android
    // Android-specific code
    using Android.App;
    using Android.Content;
    using Android.OS;
    
    var activity = Platform.CurrentActivity;
    var intent = new Intent(Intent.ActionView);
    activity.StartActivity(intent);
#elif iOS
    // iOS-specific code
    using UIKit;
    using Foundation;
    
    var viewController = Platform.GetCurrentUIViewController();
    var alert = UIAlertController.Create("Title", "Message", UIAlertControllerStyle.Alert);
    viewController.PresentViewController(alert, true, null);
#elif Windows
    // Windows-specific code
    using Windows.UI.Notifications;
    
    var notifier = ToastNotificationManager.CreateToastNotifier();
#endif
```

#### 3. **Third-Party Native Libraries**
You can call Java, Kotlin, Swift, and Objective-C libraries:

**Android Example** (calling a Java library):
```csharp
#if Android
using Com.Google.Android.Material.Snackbar;

var snackbar = Snackbar.Make(view, "Hello from Java library!", Snackbar.LengthLong);
snackbar.Show();
#endif
```

**iOS Example** (calling an Objective-C/Swift library):
```csharp
#if iOS
using Foundation;
using UIKit;

var userDefaults = NSUserDefaults.StandardUserDefaults;
userDefaults.SetString("value", "key");
userDefaults.Synchronize();
#endif
```

### MAUI-Specific Service Implementations

The project includes MAUI-specific implementations of core services:

**Location**: [/src/Client/Boilerplate.Client.Maui/Services/](/src/Client/Boilerplate.Client.Maui/Services/)

- **`MauiStorageService.cs`**: Uses MAUI's `Preferences` and `SecureStorage` APIs
- **`MauiExceptionHandler.cs`**: Can integrate with Firebase Crashlytics or AppCenter
- **`MauiAppUpdateService.cs`**: Checks for updates and opens the appropriate app store
- **`MauiDeviceCoordinator.cs`**: Implements `IBitDeviceCoordinator` for MAUI
- **`MauiExternalNavigationService.cs`**: Opens URLs in the system browser
- **`MauiLocalHttpServer.cs`**: Creates a local HTTP server for OAuth callbacks
- **`MauiTelemetryContext.cs`**: Provides platform-specific telemetry information
- **`MauiWebAuthnService.cs`**: Implements WebAuthn/FIDO2 for native apps

---

## App Versioning

The MAUI project automatically calculates version codes for Android and version strings for all platforms.

**Location**: [/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj](/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj)

### Android Version Code Calculation

Android requires a unique, **increasing integer** for each release. The template derives this from the semantic version:

```xml
<PropertyGroup>
    <!-- Extract major, minor, and patch from Version (e.g., "1.2.3") -->
    <_MajorVersionString>$([System.Text.RegularExpressions.Regex]::Match($(Version), '^(\d+)').Groups[1].Value)</_MajorVersionString>
    <_MinorVersionString>$([System.Text.RegularExpressions.Regex]::Match($(Version), '^\d+\.(\d+)').Groups[1].Value)</_MinorVersionString>
    <_PatchVersionString>$([System.Text.RegularExpressions.Regex]::Match($(Version), '^\d+\.\d+\.(\d+)$').Groups[1].Value)</_PatchVersionString>

    <MajorVersion>$([System.Int32]::Parse($(_MajorVersionString)))</MajorVersion>
    <MinorVersion>$([System.Int32]::Parse($(_MinorVersionString)))</MinorVersion>
    
    <!-- Default patch to 0 if not present (e.g., "1.2" becomes "1.2.0") -->
    <_PatchVersionString Condition="'$(_PatchVersionString)' == ''">0</_PatchVersionString>
    <PatchVersion>$([System.Int32]::Parse($(_PatchVersionString)))</PatchVersion>

    <!-- Calculate: (Major * 10000) + (Minor * 100) + Patch -->
    <!-- Example: Version "1.2.3" becomes 10203 -->
    <ApplicationVersion>
        $([MSBuild]::Add(
            $([MSBuild]::Add(
                $([MSBuild]::Multiply($(MajorVersion), 10000)),
                $([MSBuild]::Multiply($(MinorVersion), 100))
            )),
            $(PatchVersion)
        ))
    </ApplicationVersion>
</PropertyGroup>
```

### Version Examples

| Semantic Version | Android versionCode | iOS/Windows Version |
|------------------|---------------------|---------------------|
| `1.0`            | `10000`             | `1.0`               |
| `1.0.0`          | `10000`             | `1.0.0`             |
| `1.0.1`          | `10001`             | `1.0.1`             |
| `1.2.3`          | `10203`             | `1.2.3`             |
| `2.5.17`         | `20517`             | `2.5.17`            |

**Important**: This scheme supports versions up to `9.99.99` before running out of Android versionCode space (max is ~2.1 billion).

---

## Performance Optimizations

The template includes several performance optimizations for release builds.

### Android Optimizations

**Location**: [/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj](/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj)

```xml
<PropertyGroup Condition="$(TargetFramework.Contains('-android')) and '$(Environment)' != 'Development'">
    <!-- Use R8 for code shrinking and obfuscation -->
    <AndroidLinkTool>r8</AndroidLinkTool>
    
    <!-- Enable ahead-of-time compilation for better performance -->
    <RunAOTCompilation>True</RunAOTCompilation>
    
    <!-- Remove IL after AOT to reduce app size -->
    <AndroidStripILAfterAOT>true</AndroidStripILAfterAOT>
    
    <!-- Enable profiled AOT for better startup time -->
    <AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>
    
    <!-- Use custom AOT profile if available -->
    <MauiUseDefaultAotProfile Condition="Exists('custom.aprof')">false</MauiUseDefaultAotProfile>
    
    <!-- Build only for ARM64 for APKs (most modern devices) -->
    <RuntimeIdentifiers Condition="'$(AndroidPackageFormat)' == 'apk'">android-arm64</RuntimeIdentifiers>
    
    <!-- LLVM disabled due to a known issue -->
    <EnableLLVM>false</EnableLLVM>
</PropertyGroup>
```

**What These Do**:
- **R8**: Shrinks code size and obfuscates bytecode (makes reverse engineering harder)
- **AOT Compilation**: Compiles C# to native code ahead of time (faster startup, better runtime performance)
- **Strip IL**: Removes intermediate language after AOT compilation (smaller app size)
- **Profiled AOT**: Uses runtime profiles to optimize the most-used code paths
- **ARM64**: Modern devices use ARM64; targeting only this reduces app size significantly

### iOS/macOS Optimizations

```xml
<PropertyGroup Condition="$(TargetFramework.Contains('-ios')) and '$(Environment)' != 'Development'">
    <!-- Enable concurrent garbage collection -->
    <EnableSGenConc>True</EnableSGenConc>
    
    <!-- Use interpreter for all assemblies to avoid iOS JIT restrictions -->
    <MtouchInterpreter>-all</MtouchInterpreter>
    
    <CodesignEntitlements>Platforms/iOS/Entitlements.Production.plist</CodesignEntitlements>
</PropertyGroup>

<PropertyGroup Condition="$(TargetFramework.Contains('-maccatalyst')) and '$(Environment)' != 'Development'">
    <CodesignEntitlements>Platforms/MacCatalyst/Entitlements.Production.plist</CodesignEntitlements>
    
    <!-- Required for macOS app store distribution -->
    <UseHardenedRuntime>true</UseHardenedRuntime>
    
    <MtouchInterpreter>-all</MtouchInterpreter>
</PropertyGroup>
```

**What These Do**:
- **EnableSGenConc**: Enables concurrent garbage collection for better performance
- **MtouchInterpreter**: iOS doesn't allow JIT compilation for security reasons; interpreter mode works around this
- **UseHardenedRuntime**: Security feature required for Mac App Store submission

### Development vs Production

```xml
<PropertyGroup>
    <!-- Enable C# Hot Reload in development -->
    <UseInterpreter Condition="'$(Environment)' == 'Development'">True</UseInterpreter>
    
    <!-- Skip static library validation in development for faster builds -->
    <SkipStaticLibraryValidation Condition="'$(Environment)' == 'Development'">true</SkipStaticLibraryValidation>
</PropertyGroup>
```

### Compression (Disabled for MAUI)

```xml
<PropertyGroup>
    <CompressionEnabled>false</CompressionEnabled>
    <!-- Compression creates .br and .gz files, which are useful for Blazor WebAssembly.
         However, they only increase app bundle size in MAUI without providing benefits. -->
</PropertyGroup>
```

---

## MAUI-Specific Pages and Components

While most pages live in `Client.Core` and are shared across all platforms, you can create MAUI-specific pages when you need **exclusive native functionality**.

### When to Create MAUI-Specific Pages

Create pages in `Client.Maui/Components/Pages/` when:
- The page requires direct access to native APIs (camera, sensors, etc.)
- You want to avoid the complexity of dependency injection for platform-specific features
- The functionality doesn't make sense for the web version

### Example: AboutPage

**Location**: [/src/Client/Boilerplate.Client.Maui/Components/Pages/AboutPage.razor](/src/Client/Boilerplate.Client.Maui/Components/Pages/AboutPage.razor)

```xml
@attribute [Route(PageUrls.About)]
@attribute [Route("{culture?}" + PageUrls.About)]
@inherits AppPageBase

<AppPageData Title="@Localizer[nameof(AppStrings.About)]"
             PageTitle="@Localizer[nameof(AppStrings.AboutPageTitle)]" />

<CascadingValue Value=BitDir.Ltr>
    <section>
        <BitStack Gap="3rem">
            <BitCard FullSize>
                <BitText Typography="BitTypography.Body1">
                    For Razor pages that are exclusively dependent on native Maui features 
                    for Android, iOS, Windows, and macOS functionality, consider using 
                    Client/Maui project instead of placing them in Client/Core project.
                    <br />
                    This approach allows direct access to native features without the need 
                    for dependency injection (DI) or publish-subscribe messaging patterns.
                </BitText>

                <BitStack AutoWidth>
                    <BitText>App Name: <b>@appName</b></BitText>
                    <BitText>OEM: <b>@oem</b></BitText>
                    <BitText>Platform: <b>@platform</b></BitText>
                    <BitText>WebView: <b>@webView</b></BitText>
                    <BitText>App Version: <b>@appVersion</b></BitText>
                    <BitText>Process ID: <b>@processId</b></BitText>
                </BitStack>
            </BitCard>
        </BitStack>
    </section>
</CascadingValue>
```

**Code-Behind**: [AboutPage.razor.cs](/src/Client/Boilerplate.Client.Maui/Components/Pages/AboutPage.razor.cs)

```csharp
public partial class AboutPage
{
    [AutoInject] private ITelemetryContext telemetryContext = default!;

    private string oem = default!;
    private string appName = default!;
    private string webView = default!;
    private string platform = default!;
    private string processId = default!;
    private string appVersion = default!;

    protected override async Task OnInitAsync()
    {
        await base.OnInitAsync();

        // Direct access to MAUI APIs - no DI needed
        appName = AppInfo.Name;
        webView = telemetryContext.WebView!;
        platform = telemetryContext.Platform!;
        oem = DeviceInfo.Current.Manufacturer;
        appVersion = telemetryContext.AppVersion!;
        
        // Platform-specific code
        if (AppPlatform.IsAndroid)
        {
#if Android
            appVersion += " / " + Platform.CurrentActivity!.PackageManager!
                .GetPackageInfo(AppInfo.PackageName, default(Android.Content.PM.PackageInfoFlags))!
                .VersionCode;
#endif
        }
        
        processId = Environment.ProcessId.ToString();
    }
}
```

### Alternative: Cross-Platform with DI

If you want a page to work on both web and native, but need platform-specific behavior:

1. **Define an interface in `Shared`**:
```csharp
public interface INativeCameraService
{
    Task<Stream?> TakePictureAsync();
}
```

2. **Implement for MAUI** in `Client.Maui/Services`:
```csharp
public class MauiCameraService : INativeCameraService
{
    public async Task<Stream?> TakePictureAsync()
    {
        var photo = await MediaPicker.CapturePhotoAsync();
        return await photo.OpenReadAsync();
    }
}
```

3. **Implement for Web** in `Client.Web/Services`:
```csharp
public class WebCameraService : INativeCameraService
{
    public Task<Stream?> TakePictureAsync()
    {
        // Use JavaScript interop to access navigator.mediaDevices.getUserMedia()
        throw new NotSupportedException("Use HTML5 file input for web.");
    }
}
```

4. **Use in a shared component** in `Client.Core`:
```csharp
public partial class ProfileEditPage
{
    [AutoInject] private INativeCameraService cameraService = default!;
    
    private async Task TakeProfilePictureAsync()
    {
        var photo = await cameraService.TakePictureAsync();
        // Process photo...
    }
}
```

---

## Summary

In this stage, you learned:

✅ **What .NET MAUI Blazor Hybrid is** and why it's beneficial  
✅ **Project structure** and how the MAUI project is organized  
✅ **MauiProgram.cs** and how the application initializes  
✅ **Service registration** patterns for MAUI-specific implementations  
✅ **Platform-specific code** for Android, iOS, Windows, and macOS  
✅ **Deep links and universal links** for seamless app integration  
✅ **BlazorWebView customization** for optimal performance on each platform  
✅ **Native capabilities access** including MAUI abstractions and platform-specific APIs  
✅ **App versioning** and automatic version code calculation  
✅ **Performance optimizations** for release builds  
✅ **When to create MAUI-specific pages** vs. shared pages  

---
