# Stage 21: .NET MAUI - Blazor Hybrid

Welcome to Stage 21! In this stage, you'll learn about the .NET MAUI Blazor Hybrid implementation in this project, which enables cross-platform native mobile and desktop applications using Blazor.

## Quick Navigation

**Priority Topics (from Stage 21 instructions)**:
1. [What is .NET MAUI Blazor Hybrid?](#what-is-net-maui-blazor-hybrid) - Performance, reach, and capabilities
2. [Deep Links & Universal Links](#deep-links-android-and-universal-links-ios) - Make web URLs open in your app
3. [Application Versioning](#application-versioning-for-native-apps) - How version numbers work for stores
4. [Boilerplate.Client.Windows Advantages](#boilerplateclientwindows-advantages) - Better Windows support
5. [WebView Version Importance](#webview-version-importance) - Critical for compatibility

**Additional Topics**:
- [Project Structure](#project-structure-overview) - How MAUI projects are organized
- [Understanding the Architecture](#understanding-the-architecture) - Entry points, services, and configuration
- [Platform-Specific Services](#platform-specific-services) - Storage, navigation, etc.

## What is .NET MAUI Blazor Hybrid?

**.NET MAUI (Multi-platform App UI)** is Microsoft's framework for building native cross-platform applications. **Blazor Hybrid** combines the power of Blazor web UI with native platform capabilities, allowing you to:

- **Reuse your Blazor components** across web, mobile, and desktop platforms
- **Access native device features** like TCP socket over local network, native push notifications, better file access etc.
- **Access to native libraries** like Java, Kotlin, Swift and Objective-C libraries directly in C#
- **Build once, run everywhere**: Android, iOS, macOS, and Windows
- **Share the vast majority of your codebase** with the web application

The `Boilerplate.Client.Maui` and `Boilerplate.Client.Windows` projects demonstrate this architecture in action.

### Platform Support
For detailed information on supported browsers, operating systems, and platform versions, refer to: https://bitplatform.dev/templates

**Important**: While there is excellent code compatibility, be aware of platform-specific considerations covered in this guide.


## Deep Links (Android) and Universal Links (iOS)

One of the most powerful features of native apps is the ability to handle web links directly in the app.

### What Are Deep Links / Universal Links?

**Purpose**: When a user clicks on a web app link but has the Android or iOS app installed on their device, the app opens on that specific page instead of opening in the browser.

**User Experience**: The assumption is that if someone has installed your app, they prefer using the native app over the web version.

### Configuration Requirements

#### Android - Deep Links
For Android, every new page route must be added to `MainActivity.cs` in the Android project.

**Location**: [`/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs`](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs)

**Configuration Example**:
```csharp
[IntentFilter([Intent.ActionView],
    DataSchemes = ["https", "http"],
    DataHosts = ["use-your-web-app-url-here.com"],
    DataPaths = [PageUrls.Home],
    DataPathPrefixes = [
        "/en-US", "/en-GB", /* ... other locales */,
        PageUrls.SignIn, PageUrls.SignUp, /* ... other page routes */
    ],
    AutoVerify = true,
    Categories = [Intent.ActionView, Intent.CategoryDefault, Intent.CategoryBrowsable])]
```

**Important**: Each time you add a new page to your app, you must add its route to the `DataPathPrefixes` array.

#### iOS - Universal Links
For iOS, this is handled automatically by the `apple-app-site-association` file in the `wwwroot` of the `Boilerplate.Client.Web` project. No manual configuration is needed per page!

**Location**: [`/src/Client/Boilerplate.Client.Web/wwwroot/apple-app-site-association`](/src/Client/Boilerplate.Client.Web/wwwroot/apple-app-site-association)

**How It Works**: iOS automatically reads this file from your website and handles universal links without per-page configuration.

### Important Setup Steps

Before deep/universal links will work, you must:

1. **Update the `appId`** in the `apple-app-site-association` file for iOS
2. **Update the `assetlinks.json`** file for Android  
3. **Publish your app** on Google Play Store and Apple App Store

**Note**: Deep links and universal links only work after the app is published to the respective stores.

## Application Versioning for Native Apps

### ApplicationVersion in Boilerplate.Client.Maui

The `ApplicationVersion` property in the `Boilerplate.Client.Maui.csproj` file manages the app's version for store submissions and updates.

**Purpose**: An integer version number (no decimals or dots) required by Google Play and Apple Store.

**Automatic Generation**: The project automatically generates `ApplicationVersion` from the `Version` property:
- **Example**: If `Version` is `1.7.3`, then `ApplicationVersion` becomes `10703`

```xml
<!-- In Boilerplate.Client.Maui.csproj -->
<Version>1.7.3</Version>
<!-- ApplicationVersion is automatically calculated as 10703 -->
```

This integer format is required for proper version comparison on mobile platforms.

## Boilerplate.Client.Windows Advantages

The `Boilerplate.Client.Windows` project offers several advantages over the MAUI Windows output:

### Key Benefits

1. **Broader OS Support**: Works on Windows 7, 8, 10, and 11
   - In contrast, `Boilerplate.Client.Maui`'s Windows output only works on Windows 10 and 11

2. **Better Performance**: Faster execution than the MAUI Windows version

3. **Auto-Update**: Includes automatic update functionality built-in

### When to Use Which?
- **Use Client.Windows**: For maximum Windows compatibility and best performance
- **Use Client.Maui**: When you need a unified codebase across all platforms including Windows

## WebView Version Importance

Understanding the WebView is crucial for Blazor Hybrid apps.

### Key Concepts

**Critical Component**: In addition to the OS version (Windows, Android, iOS, macOS), the **WebView version** is also critical.

**Why It Matters**: The UI runs using HTML/CSS inside a WebView:
- Your Blazor components render as HTML inside this WebView
- Modern web features require up-to-date WebView versions
- Outdated WebViews can cause compatibility issues

**Full Native Access**: Even though the UI renders in a WebView, C# .NET in MAUI/Blazor Hybrid has **complete access** to native OS features:
- You can easily use Java/Swift/Objective-C/Kotlin code directly
- You can install packages from Maven (similar to NuGet) and use them directly in C# .NET
- No limitations on native API access

**User Guidance**: Users should keep their WebView updated for best compatibility and security.

### WebView Version Management

The app checks the WebView version on Android to ensure compatibility in [`App.xaml.cs`](/src/Client/Boilerplate.Client.Maui/App.xaml.cs):

```csharp
// In App.xaml.cs OnStart()
#if Android
const int minimumSupportedWebViewVersion = 85;

if (Version.TryParse(Android.Webkit.WebView.CurrentWebViewPackage?.VersionName, 
    out var webViewVersion) 
    && webViewVersion.Major < minimumSupportedWebViewVersion)
{
    var webViewName = Android.Webkit.WebView.CurrentWebViewPackage.PackageName;
    
    await App.Current!.Windows[0].Page!.DisplayAlertAsync(
        "Boilerplate", 
        localizer[nameof(AppStrings.UpdateWebViewThroughGooglePlay)], 
        localizer[nameof(AppStrings.Ok)]);
    
    await Launcher.OpenAsync(
        $"https://play.google.com/store/apps/details?id={webViewName}");
}
#endif
```

**Why this matters**: Older Android devices may have outdated WebView versions that don't support modern web features. This check ensures a good user experience.

## Project Structure Overview

The MAUI project is located at: `src/Client/Boilerplate.Client.Maui/`

### Key Files and Their Purposes

| File/Folder | Purpose |
|------------|---------|
| `MauiProgram.cs` | Entry point and configuration for the MAUI app, similar to `Program.cs` in ASP.NET Core |
| `MauiProgram.Services.cs` | Service registration specific to MAUI (dependency injection setup) |
| `App.xaml` / `App.xaml.cs` | Application-level configuration and lifecycle events |
| `MainPage.xaml` / `MainPage.xaml.cs` | The main page that hosts the `BlazorWebView` component |
| `Platforms/` | Platform-specific code for Android, iOS, Windows, and macOS |
| `Services/` | MAUI-specific service implementations |
| `Resources/` | App icons, splash screens, images, fonts, and raw assets |

## Understanding the Architecture

### 1. Entry Point: MauiProgram.cs

The [`MauiProgram.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs) file is the starting point of the MAUI application:

```csharp
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
    
    builder
        .UseMauiApp<App>()
        .UseAppStoreInfo()
        .UseSentry(options => { /* ... */ })
        .Configuration.AddClientConfigurations(clientEntryAssemblyName: "Boilerplate.Client.Maui");
    
    builder.ConfigureServices();
    
    builder.ConfigureLifecycleEvents(lifecycle =>
    {
        // Platform-specific lifecycle events
    });
    
    SetupBlazorWebView();
    
    return builder.Build();
}
```

**Key features:**
- **Exception Handling**: Global exception handlers for `AppDomain.UnhandledException` and `TaskScheduler.UnobservedTaskException`
- **Platform Detection**: Sets `AppPlatform.IsBlazorHybrid = true`
- **Configuration**: Loads configuration from `appsettings.json` files
- **Service Registration**: Calls `ConfigureServices()` to register all dependencies
- **Deep Linking**: Configures universal link handling (iOS/macOS)
- **BlazorWebView Setup**: Customizes the WebView for each platform

### 2. Service Registration: MauiProgram.Services.cs

Services specific to MAUI are registered in [`MauiProgram.Services.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.Services.cs):

```csharp
public static void ConfigureServices(this MauiAppBuilder builder)
{
    var services = builder.Services;
    var configuration = builder.Configuration;
    
    // Shared client-core services (reused from web)
    services.AddClientCoreProjectServices(configuration);
    
    // MAUI-specific services
    services.AddScoped<IWebAuthnService, MauiWebAuthnService>();
    services.AddScoped<IExceptionHandler, MauiExceptionHandler>();
    services.AddScoped<IAppUpdateService, MauiAppUpdateService>();
    services.AddScoped<IBitDeviceCoordinator, MauiDeviceCoordinator>();
    services.AddScoped<IExternalNavigationService, MauiExternalNavigationService>();
    
    // Storage service for persistent data
    services.AddSingleton<IStorageService, MauiStorageService>();
    
    // HTTP client with proper configuration
    services.AddScoped<HttpClient>(sp => { /* ... */ });
    
    // Platform-specific services (Android, iOS, Windows, macOS)
#if Android
    services.AddClientMauiProjectAndroidServices(builder.Configuration);
#elif iOS
    services.AddClientMauiProjectIosServices(builder.Configuration);
    // ... etc
#endif
}
```

**Important**: Notice how the project reuses `AddClientCoreProjectServices()` - this is the **shared Blazor component library** used by both web and MAUI apps!

### 3. BlazorWebView: The Bridge Between Native and Web

The [`MainPage.xaml`](/src/Client/Boilerplate.Client.Maui/MainPage.xaml) file hosts the `BlazorWebView` component, which renders Blazor content inside a native WebView:

```xml
<ContentPage xmlns:b="clr-namespace:Microsoft.AspNetCore.Components.WebView.Maui;...">
    <b:BlazorWebView
        x:Name="AppWebView"
        HostPage="wwwroot/index.html">
        <b:BlazorWebView.RootComponents>
            <b:RootComponent 
                ComponentType="{x:Type core:Routes}" 
                Selector="#app-container" />
        </b:BlazorWebView.RootComponents>
    </b:BlazorWebView>
</ContentPage>
```

**How it works:**
- The `BlazorWebView` component creates a native WebView for each platform
- It loads the `wwwroot/index.html` file
- It renders the `Routes` component (from `Boilerplate.Client.Core`) inside the `#app-container` element
- All your Blazor components render inside this WebView, just like in the browser!

### 4. BlazorWebView Customization

The `SetupBlazorWebView()` method in [`MauiProgram.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs) customizes the WebView for each platform:

```csharp
private static void SetupBlazorWebView()
{
    BlazorWebViewHandler.BlazorWebViewMapper.AppendToMapping("CustomBlazorWebViewMapper", 
        static (handler, view) =>
    {
        var webView = handler.PlatformView;
        
#if Windows
        // Windows-specific WebView2 configuration
        webView.DefaultBackgroundColor = /* ... */;
        webView.CoreWebView2.PermissionRequested += /* ... */;
        
#elif iOS || Mac
        // iOS/macOS WKWebView configuration
        webView.Configuration.AllowsInlineMediaPlayback = true;
        webView.ScrollView.Bounces = false;
        webView.SetValueForKey(NSObject.FromObject(true), new NSString("inspectable"));
        
#elif Android
        // Android WebView configuration
        webView.Settings.AllowFileAccess = true;
        webView.Settings.DomStorageEnabled = true;
#endif
    });
}
```

**Platform-specific features:**
- **Windows**: Enables permissions, disables zoom in production
- **iOS/macOS**: Enables web inspector, allows inline media playback
- **Android**: Enables file access, DOM storage, and mixed content in development

## Platform-Specific Services

The MAUI project includes platform-specific implementations of shared interfaces:

### MauiStorageService

Implements `IStorageService` using MAUI's `Preferences` API in [`MauiStorageService.cs`](/src/Client/Boilerplate.Client.Maui/Services/MauiStorageService.cs):

```csharp
public partial class MauiStorageService : IStorageService
{
    public async ValueTask<string?> GetItem(string key)
    {
        return Preferences.Get(key, null);
    }
    
    public async ValueTask SetItem(string key, string? value, bool persistent = true)
    {
        if (persistent)
        {
            Preferences.Set(key, value); // Persisted to disk
        }
        else
        {
            tempStorage[key] = value; // In-memory only
        }
    }
}
```

**Usage**: Store user preferences, authentication tokens, and other data that should persist across app restarts.

### MauiExternalNavigationService

Implements `IExternalNavigationService` for opening external URLs in [`MauiExternalNavigationService.cs`](/src/Client/Boilerplate.Client.Maui/Services/MauiExternalNavigationService.cs):

```csharp
public partial class MauiExternalNavigationService : IExternalNavigationService
{
    public async Task NavigateToAsync(string url)
    {
        await Browser.OpenAsync(url, options: new()
        {
            TitleMode = BrowserTitleMode.Hide,
            PreferredToolbarColor = /* ... */,
            // Windows/macOS: Opens in system browser
            // Android/iOS: Opens in-app browser
            LaunchMode = AppPlatform.IsWindows || AppPlatform.IsMacOS 
                ? BrowserLaunchMode.External 
                : BrowserLaunchMode.SystemPreferred
        });
    }
}
```

**Usage**: Open external links (like terms of service, privacy policy) in the appropriate browser.