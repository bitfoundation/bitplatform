# Stage 21: .NET MAUI - Blazor Hybrid

Welcome to Stage 21! In this stage, you'll learn about the .NET MAUI Blazor Hybrid implementation in this project, which enables cross-platform native mobile and desktop applications using Blazor.

**Focus of This Stage**: This guide prioritizes the most important practical aspects of working with MAUI Blazor Hybrid apps - especially features and configurations that developers frequently need to understand and modify. We'll cover deep linking, versioning, platform differences, and other key topics before diving into the detailed project structure.

## Quick Navigation

**Priority Topics (from Stage 21 instructions)**:
1. [Why Use Native Platform Projects?](#why-use-native-platform-projects) - Performance, reach, and capabilities
2. [Deep Links & Universal Links](#deep-links-android-and-universal-links-ios) - Make web URLs open in your app
3. [Application Versioning](#application-versioning-for-native-apps) - How version numbers work for stores
4. [Boilerplate.Client.Windows Advantages](#boilerplateclientwindows-advantages) - Better Windows support
5. [App Size Best Practices](#app-size-best-practices) - Keep your app size optimized
6. [WebView Version Importance](#webview-version-importance) - Critical for compatibility

**Additional Topics**:
- [Project Structure](#project-structure-overview) - How MAUI projects are organized
- [Native Platform Features](#native-platform-features) - Push notifications, storage, etc.
- [Platform-Specific Code](#platform-specific-code-organization) - Organizing per-platform code
- [Deployment](#deployment) - Publishing to app stores

## What is .NET MAUI Blazor Hybrid?

**.NET MAUI (Multi-platform App UI)** is Microsoft's framework for building native cross-platform applications. **Blazor Hybrid** combines the power of Blazor web UI with native platform capabilities, allowing you to:

- **Reuse your Blazor components** across web, mobile, and desktop platforms
- **Access native device features** like camera, geolocation, push notifications, and file system
- **Build once, run everywhere**: Android, iOS, macOS, and Windows
- **Share the vast majority of your codebase** with the web application

The `Boilerplate.Client.Maui` and `Boilerplate.Client.Windows` projects demonstrate this architecture in action.

## Why Use Native Platform Projects?

The native platform projects (`Boilerplate.Client.Windows` and `Boilerplate.Client.Maui`) provide significant advantages:

### Key Benefits
- **Better Performance**: Faster execution compared to web versions, with full native runtime capabilities
- **Wider User Reach**: Access to users through Google Play Store, Apple App Store, and Microsoft Store
- **Full Native Capabilities**: Complete access to operating system features (TCP connections, file system, hardware, etc.)
- **Code Compatibility**: Most code that works in the web version will work in these projects too

### Platform Support
For detailed information on supported browsers, operating systems, and platform versions, refer to: https://bitplatform.dev/templates

**Important**: While there is excellent code compatibility, be aware of platform-specific considerations covered in this guide.


## Deep Links (Android) and Universal Links (iOS)

One of the most powerful features of native apps is the ability to handle web links directly in the app.

### What Are Deep Links / Universal Links?

**Purpose**: When a user clicks on a web app link but has the Android or iOS app installed on their device, the app opens on that specific page instead of opening in the browser.

**User Experience**: The assumption is that if someone has installed your app, they prefer using the native app over the web version.

### Configuration Requirements

#### Android - Deep Links
For Android, every new page route must be added to `MainActivity.cs` in the Android project.

**Location**: [`/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs`](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs)

**Configuration Example**:
```csharp
[IntentFilter([Intent.ActionView],
    DataSchemes = ["https", "http"],
    DataHosts = ["use-your-web-app-url-here.com"],
    DataPaths = [PageUrls.Home],
    DataPathPrefixes = [
        "/en-US", "/en-GB", /* ... other locales */,
        PageUrls.SignIn, PageUrls.SignUp, /* ... other page routes */
    ],
    AutoVerify = true,
    Categories = [Intent.ActionView, Intent.CategoryDefault, Intent.CategoryBrowsable])]
```

**Important**: Each time you add a new page to your app, you must add its route to the `DataPathPrefixes` array.

#### iOS - Universal Links
For iOS, this is handled automatically by the `apple-app-site-association` file in the `wwwroot` of the `Boilerplate.Client.Web` project. No manual configuration is needed per page!

**Location**: [`/src/Client/Boilerplate.Client.Web/wwwroot/apple-app-site-association`](/src/Client/Boilerplate.Client.Web/wwwroot/apple-app-site-association)

**How It Works**: iOS automatically reads this file from your website and handles universal links without per-page configuration.

### Important Setup Steps

Before deep/universal links will work, you must:

1. **Update the `appId`** in the `apple-app-site-association` file for iOS
2. **Update the `assetlinks.json`** file for Android  
3. **Publish your app** on Google Play Store and Apple App Store

**Note**: Deep links and universal links only work after the app is published to the respective stores.

## Application Versioning for Native Apps

### ApplicationVersion in Boilerplate.Client.Maui

The `ApplicationVersion` property in the `Boilerplate.Client.Maui.csproj` file manages the app's version for store submissions and updates.

**Purpose**: An integer version number (no decimals or dots) required by Google Play and Apple Store.

**Automatic Generation**: The project automatically generates `ApplicationVersion` from the `Version` property:
- **Example**: If `Version` is `1.7.3`, then `ApplicationVersion` becomes `10703`

```xml
<!-- In Boilerplate.Client.Maui.csproj -->
<Version>1.7.3</Version>
<!-- ApplicationVersion is automatically calculated as 10703 -->
```

This integer format is required for proper version comparison on mobile platforms.

## Boilerplate.Client.Windows Advantages

The `Boilerplate.Client.Windows` project offers several advantages over the MAUI Windows output:

### Key Benefits

1. **Broader OS Support**: Works on Windows 7, 8, 10, and 11
   - In contrast, `Boilerplate.Client.Maui`'s Windows output only works on Windows 10 and 11

2. **Better Performance**: Faster execution than the MAUI Windows version

3. **Auto-Update**: Includes automatic update functionality built-in

### When to Use Which?
- **Use Client.Windows**: For maximum Windows compatibility and best performance
- **Use Client.Maui**: When you need a unified codebase across all platforms including Windows

## App Size Best Practices

It's important to keep your app size optimized for the best user experience.

### Size Comparison
- **Recommendation**: Compare your published app size with the published apps available at https://bitplatform.dev/demos
- **Warning**: If your app size is significantly larger than the reference apps, something might be misconfigured

This helps ensure optimal app performance and download experience for users. Smaller app sizes lead to:
- Faster downloads
- Less storage usage on devices
- Better user adoption rates

## WebView Version Importance

Understanding the WebView is crucial for Blazor Hybrid apps.

### Key Concepts

**Critical Component**: In addition to the OS version (Windows, Android, iOS, macOS), the **WebView version** is also critical.

**Why It Matters**: The UI runs using HTML/CSS inside a WebView:
- Your Blazor components render as HTML inside this WebView
- Modern web features require up-to-date WebView versions
- Outdated WebViews can cause compatibility issues

**Full Native Access**: Even though the UI renders in a WebView, C# .NET in MAUI/Blazor Hybrid has **complete access** to native OS features:
- You can easily use Java/Swift/Objective-C/Kotlin code directly
- You can install packages from Maven (similar to NuGet) and use them directly in C# .NET
- No limitations on native API access

**User Guidance**: Users should keep their WebView updated for best compatibility and security.

### WebView Version Management

The app checks the WebView version on Android to ensure compatibility in [`App.xaml.cs`](/src/Client/Boilerplate.Client.Maui/App.xaml.cs):

```csharp
// In App.xaml.cs OnStart()
#if Android
const int minimumSupportedWebViewVersion = 85;

if (Version.TryParse(Android.Webkit.WebView.CurrentWebViewPackage?.VersionName, 
    out var webViewVersion) 
    && webViewVersion.Major < minimumSupportedWebViewVersion)
{
    var webViewName = Android.Webkit.WebView.CurrentWebViewPackage.PackageName;
    
    await App.Current!.Windows[0].Page!.DisplayAlertAsync(
        "Boilerplate", 
        localizer[nameof(AppStrings.UpdateWebViewThroughGooglePlay)], 
        localizer[nameof(AppStrings.Ok)]);
    
    await Launcher.OpenAsync(
        $"https://play.google.com/store/apps/details?id={webViewName}");
}
#endif
```

**Why this matters**: Older Android devices may have outdated WebView versions that don't support modern web features. This check ensures a good user experience.

## Project Structure Overview

The MAUI project is located at: `src/Client/Boilerplate.Client.Maui/`

### Key Files and Their Purposes

| File/Folder | Purpose |
|------------|---------|
| `MauiProgram.cs` | Entry point and configuration for the MAUI app, similar to `Program.cs` in ASP.NET Core |
| `MauiProgram.Services.cs` | Service registration specific to MAUI (dependency injection setup) |
| `App.xaml` / `App.xaml.cs` | Application-level configuration and lifecycle events |
| `MainPage.xaml` / `MainPage.xaml.cs` | The main page that hosts the `BlazorWebView` component |
| `Platforms/` | Platform-specific code for Android, iOS, Windows, and macOS |
| `Services/` | MAUI-specific service implementations |
| `Resources/` | App icons, splash screens, images, fonts, and raw assets |

## Understanding the Architecture

### 1. Entry Point: MauiProgram.cs

The [`MauiProgram.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs) file is the starting point of the MAUI application:

```csharp
public static MauiApp CreateMauiApp()
{
    var builder = MauiApp.CreateBuilder();
    
    builder
        .UseMauiApp<App>()
        .UseAppStoreInfo()
        .UseSentry(options => { /* ... */ })
        .Configuration.AddClientConfigurations(clientEntryAssemblyName: "Boilerplate.Client.Maui");
    
    builder.ConfigureServices();
    
    builder.ConfigureLifecycleEvents(lifecycle =>
    {
        // Platform-specific lifecycle events
    });
    
    SetupBlazorWebView();
    
    return builder.Build();
}
```

**Key features:**
- **Exception Handling**: Global exception handlers for `AppDomain.UnhandledException` and `TaskScheduler.UnobservedTaskException`
- **Platform Detection**: Sets `AppPlatform.IsBlazorHybrid = true`
- **Configuration**: Loads configuration from `appsettings.json` files
- **Service Registration**: Calls `ConfigureServices()` to register all dependencies
- **Deep Linking**: Configures universal link handling (iOS/macOS)
- **BlazorWebView Setup**: Customizes the WebView for each platform

### 2. Service Registration: MauiProgram.Services.cs

Services specific to MAUI are registered in [`MauiProgram.Services.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.Services.cs):

```csharp
public static void ConfigureServices(this MauiAppBuilder builder)
{
    var services = builder.Services;
    var configuration = builder.Configuration;
    
    // Shared client-core services (reused from web)
    services.AddClientCoreProjectServices(builder.Configuration);
    
    // MAUI-specific services
    services.AddScoped<IWebAuthnService, MauiWebAuthnService>();
    services.AddScoped<IExceptionHandler, MauiExceptionHandler>();
    services.AddScoped<IAppUpdateService, MauiAppUpdateService>();
    services.AddScoped<IBitDeviceCoordinator, MauiDeviceCoordinator>();
    services.AddScoped<IExternalNavigationService, MauiExternalNavigationService>();
    
    // Storage service for persistent data
    services.AddSingleton<IStorageService, MauiStorageService>();
    
    // HTTP client with proper configuration
    services.AddScoped<HttpClient>(sp => { /* ... */ });
    
    // Platform-specific services (Android, iOS, Windows, macOS)
#if Android
    services.AddClientMauiProjectAndroidServices(builder.Configuration);
#elif iOS
    services.AddClientMauiProjectIosServices(builder.Configuration);
    // ... etc
#endif
}
```

**Important**: Notice how the project reuses `AddClientCoreProjectServices()` - this is the **shared Blazor component library** used by both web and MAUI apps!

### 3. BlazorWebView: The Bridge Between Native and Web

The [`MainPage.xaml`](/src/Client/Boilerplate.Client.Maui/MainPage.xaml) file hosts the `BlazorWebView` component, which renders Blazor content inside a native WebView:

```xml
<ContentPage xmlns:b="clr-namespace:Microsoft.AspNetCore.Components.WebView.Maui;...">
    <b:BlazorWebView
        x:Name="AppWebView"
        HostPage="wwwroot/index.html">
        <b:BlazorWebView.RootComponents>
            <b:RootComponent 
                ComponentType="{x:Type core:Routes}" 
                Selector="#app-container" />
        </b:BlazorWebView.RootComponents>
    </b:BlazorWebView>
</ContentPage>
```

**How it works:**
- The `BlazorWebView` component creates a native WebView for each platform
- It loads the `wwwroot/index.html` file
- It renders the `Routes` component (from `Boilerplate.Client.Core`) inside the `#app-container` element
- All your Blazor components render inside this WebView, just like in the browser!

### 4. BlazorWebView Customization

The `SetupBlazorWebView()` method in [`MauiProgram.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs) customizes the WebView for each platform:

```csharp
private static void SetupBlazorWebView()
{
    BlazorWebViewHandler.BlazorWebViewMapper.AppendToMapping("CustomBlazorWebViewMapper", 
        static (handler, view) =>
    {
        var webView = handler.PlatformView;
        
#if Windows
        // Windows-specific WebView2 configuration
        webView.DefaultBackgroundColor = /* ... */;
        webView.CoreWebView2.PermissionRequested += /* ... */;
        
#elif iOS || Mac
        // iOS/macOS WKWebView configuration
        webView.Configuration.AllowsInlineMediaPlayback = true;
        webView.ScrollView.Bounces = false;
        webView.SetValueForKey(NSObject.FromObject(true), new NSString("inspectable"));
        
#elif Android
        // Android WebView configuration
        webView.Settings.AllowFileAccess = true;
        webView.Settings.DomStorageEnabled = true;
#endif
    });
}
```

**Platform-specific features:**
- **Windows**: Enables permissions, disables zoom in production
- **iOS/macOS**: Enables web inspector, allows inline media playback
- **Android**: Enables file access, DOM storage, and mixed content in development

## Platform-Specific Services

The MAUI project includes platform-specific implementations of shared interfaces:

### MauiStorageService

Implements `IStorageService` using MAUI's `Preferences` API in [`MauiStorageService.cs`](/src/Client/Boilerplate.Client.Maui/Services/MauiStorageService.cs):

```csharp
public partial class MauiStorageService : IStorageService
{
    public async ValueTask<string?> GetItem(string key)
    {
        return Preferences.Get(key, null);
    }
    
    public async ValueTask SetItem(string key, string? value, bool persistent = true)
    {
        if (persistent)
        {
            Preferences.Set(key, value); // Persisted to disk
        }
        else
        {
            tempStorage[key] = value; // In-memory only
        }
    }
}
```

**Usage**: Store user preferences, authentication tokens, and other data that should persist across app restarts.

### MauiDeviceCoordinator

Implements `IBitDeviceCoordinator` for platform-specific UI coordination in [`MauiDeviceCoordinator.cs`](/src/Client/Boilerplate.Client.Maui/Services/MauiDeviceCoordinator.cs):

```csharp
public partial class MauiDeviceCoordinator : IBitDeviceCoordinator
{
    public async Task ApplyTheme(bool isDark)
    {
        Application.Current!.UserAppTheme = isDark ? AppTheme.Dark : AppTheme.Light;
        
#if Android
        // Update Android status bar color
        window.SetStatusBarColor(Android.Graphics.Color.ParseColor(
            isDark ? ThemeColors.PrimaryDarkBgColor : ThemeColors.PrimaryLightBgColor));
        
#elif iOS
        // Update iOS status bar style
        var statusBarStyle = isDark ? UIStatusBarStyle.LightContent : UIStatusBarStyle.DarkContent;
        UIApplication.SharedApplication.SetStatusBarStyle(statusBarStyle, false);
#endif
    }
}
```

**Usage**: Coordinate theme changes, status bar styling, and other device-level UI updates.

### MauiExternalNavigationService

Implements `IExternalNavigationService` for opening external URLs in [`MauiExternalNavigationService.cs`](/src/Client/Boilerplate.Client.Maui/Services/MauiExternalNavigationService.cs):

```csharp
public partial class MauiExternalNavigationService : IExternalNavigationService
{
    public async Task NavigateToAsync(string url)
    {
        await Browser.OpenAsync(url, options: new()
        {
            TitleMode = BrowserTitleMode.Hide,
            PreferredToolbarColor = /* ... */,
            // Windows/macOS: Opens in system browser
            // Android/iOS: Opens in-app browser
            LaunchMode = AppPlatform.IsWindows || AppPlatform.IsMacOS 
                ? BrowserLaunchMode.External 
                : BrowserLaunchMode.SystemPreferred
        });
    }
}
```

**Usage**: Open external links (like terms of service, privacy policy) in the appropriate browser.

## Native Platform Features

### 1. Push Notifications

The project includes complete push notification support for all platforms:

**Platform-Specific Implementations:**
- **Android**: Uses Firebase Cloud Messaging (FCM v1)
- **iOS**: Uses Apple Push Notification Service (APNs)
- **macOS**: Uses APNs for macOS
- **Windows**: Uses Windows Notification Service (WNS)

**Example - Android Implementation** in [`AndroidPushNotificationService.cs`](/src/Client/Boilerplate.Client.Maui/Platforms/Android/Services/AndroidPushNotificationService.cs):

```csharp
public partial class AndroidPushNotificationService : PushNotificationServiceBase
{
    public override async Task<PushNotificationSubscriptionDto?> GetSubscription(
        CancellationToken cancellationToken)
    {
        // Wait for Firebase token
        while (string.IsNullOrEmpty(Token))
        {
            await Task.Delay(TimeSpan.FromSeconds(1), cancellationToken);
        }
        
        return new PushNotificationSubscriptionDto
        {
            DeviceId = GetDeviceId(),
            Platform = "fcmV1",
            PushChannel = Token
        };
    }
}
```

**Deep Linking with Push Notifications:**

When a user taps a notification, you can open a specific page in the app. See [`MainActivity.cs`](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs) (Android) for the implementation:

```csharp
private static void HandlePushNotificationTap(Intent? intent)
{
    // Extract pageUrl from notification data
    var pageUrl = /* ... extract from intent ... */;
    
    if (string.IsNullOrEmpty(pageUrl) is false)
    {
        _ = Routes.OpenUniversalLink(pageUrl ?? PageUrls.Home);
    }
}
```

### 2. Universal Deep Links

The app supports universal links (HTTPS URLs that open the app instead of the browser):

**Android - Intent Filter in [`MainActivity.cs`](/src/Client/Boilerplate.Client.Maui/Platforms/Android/MainActivity.cs):**

```csharp
[IntentFilter([Intent.ActionView],
    DataSchemes = ["https", "http"],
    DataHosts = ["use-your-web-app-url-here.com"],
    DataPaths = [PageUrls.Home],
    DataPathPrefixes = [
        "/en-US", "/en-GB", /* ... */,
        PageUrls.SignIn, PageUrls.SignUp, /* ... */
    ],
    AutoVerify = true,
    Categories = [Intent.ActionView, Intent.CategoryDefault, Intent.CategoryBrowsable])]
```

**iOS/macOS - Handled in [`MauiProgram.cs`](/src/Client/Boilerplate.Client.Maui/MauiProgram.cs):**

```csharp
lifecycle.AddiOS(ios =>
{
    bool HandleAppLink(NSUserActivity? userActivity)
    {
        if (userActivity?.ActivityType == NSUserActivityType.BrowsingWeb 
            && userActivity.WebPageUrl is not null)
        {
            var url = $"{userActivity.WebPageUrl.Path}?{userActivity.WebPageUrl.Query}";
            _ = Routes.OpenUniversalLink(url);
            return true;
        }
        return false;
    }
    
    ios.FinishedLaunching((app, data) => HandleAppLink(app.UserActivity));
    ios.ContinueUserActivity((app, userActivity, handler) => HandleAppLink(userActivity));
});
```

**Usage**: When a user clicks an HTTPS link to your website, if the app is installed, the link opens in the app instead of the browser. This provides a seamless experience!

### 3. App Store Rating

The project integrates `Plugin.Maui.AppRating` to request user reviews in [`App.xaml.cs`](/src/Client/Boilerplate.Client.Maui/App.xaml.cs):

```csharp
// Request store review after user updates their profile
pubSubHandlerReferenceToKeepAlive = pubSubService.Subscribe(
    ClientPubSubMessages.PROFILE_UPDATED, async _ =>
{
    if ((await storageService.GetItem("StoreReviewRequested")) is "true")
        return;
    
    await AppRating.Default!.PerformInAppRateAsync(
        isTestOrDebugMode: AppEnvironment.IsDevelopment());
    
    await storageService.SetItem("StoreReviewRequested", "true");
});
```

**Best Practice**: Request reviews at opportune moments (e.g., after a successful action) to maximize positive ratings.

### 4. Local Notifications

The project uses `Plugin.LocalNotification` for displaying local notifications:

```csharp
// Check if notifications are available
if (LocalNotificationCenter.Current.IsSupported 
    && await LocalNotificationCenter.Current.AreNotificationsEnabled())
{
    // Request permission if needed
    await LocalNotificationCenter.Current.RequestNotificationPermission();
}
```

## Platform-Specific Code Organization

The `Platforms/` folder contains platform-specific code:

```
Platforms/
├── Android/
│   ├── MainActivity.cs           # Main activity and deep link handling
│   ├── MainApplication.cs        # Application-level Android code
│   ├── AndroidManifest.xml       # Android app permissions and configuration
│   ├── Resources/                # Android resources (strings, drawables, etc.)
│   ├── Services/                 # Android-specific services
│   │   ├── AndroidPushNotificationService.cs
│   │   └── PushNotificationFirebaseMessagingService.cs
│   └── Extensions/               # Android DI extensions
├── iOS/
│   ├── AppDelegate.cs            # iOS app lifecycle
│   ├── Program.cs                # iOS entry point
│   ├── Info.plist                # iOS app configuration
│   ├── PrivacyInfo.xcprivacy     # iOS privacy manifest
│   ├── Entitlements.*.plist      # iOS capabilities (push, etc.)
│   └── Services/                 # iOS-specific services
├── MacCatalyst/
│   └── Services/                 # macOS-specific services
├── Windows/
│   ├── app.manifest              # Windows app capabilities
│   ├── Package.appxmanifest      # Windows Store configuration
│   └── Services/                 # Windows-specific services
└── Tizen/                        # (Optional) Samsung Tizen support
```

### Using Conditional Compilation

Use preprocessor directives to write platform-specific code:

```csharp
#if Android
    // Android-specific code
    var deviceId = Android.Provider.Settings.Secure.GetString(
        Platform.AppContext.ContentResolver, 
        Android.Provider.Settings.Secure.AndroidId);
        
#elif iOS
    // iOS-specific code
    var deviceId = UIKit.UIDevice.CurrentDevice.IdentifierForVendor.AsString();
    
#elif Windows
    // Windows-specific code
    var deviceId = Windows.System.Profile.SystemIdentification
        .GetSystemIdForPublisher().Id;
#endif
```

## Shared Code with Web Application

One of the biggest advantages of this architecture is **code reuse**. The vast majority of your UI code is in `Boilerplate.Client.Core` and is shared between:

- **Web (Blazor WebAssembly)**: `Boilerplate.Client.Web`
- **MAUI Mobile/Desktop**: `Boilerplate.Client.Maui`
- **Windows Forms Hybrid**: `Boilerplate.Client.Windows`

**What's shared:**
- All Blazor components (`.razor` files)
- All pages and layouts
- All client-side services
- All styles (`.scss` files)
- All TypeScript/JavaScript code
- All configuration logic

**What's platform-specific:**
- Storage implementation (`IStorageService`)
- Device coordination (`IBitDeviceCoordinator`)
- Exception handling (`IExceptionHandler`)
- App update logic (`IAppUpdateService`)
- External navigation (`IExternalNavigationService`)
- Push notifications (`IPushNotificationService`)

## Building and Running the MAUI App

### Target Frameworks

The [`.csproj`](/src/Client/Boilerplate.Client.Maui/Boilerplate.Client.Maui.csproj) file defines multiple target frameworks:

```xml
<TargetFrameworks>
    net10.0-android;
    net10.0-ios;
    net10.0-maccatalyst
</TargetFrameworks>

<!-- Windows only available on Windows machines -->
<TargetFrameworks Condition="$([MSBuild]::IsOSPlatform('windows'))">
    $(TargetFrameworks);net10.0-windows10.0.19041.0
</TargetFrameworks>
```

### Building for a Specific Platform

```powershell
# Android
dotnet build -t:Run -f net10.0-android

# iOS (requires Mac)
dotnet build -t:Run -f net10.0-ios

# macOS
dotnet build -t:Run -f net10.0-maccatalyst

# Windows
dotnet build -t:Run -f net10.0-windows10.0.19041.0
```

### Performance Optimizations

The project includes several performance optimizations:

**Android (Release builds):**
```xml
<AndroidLinkTool>r8</AndroidLinkTool>
<RunAOTCompilation>True</RunAOTCompilation>
<AndroidStripILAfterAOT>true</AndroidStripILAfterAOT>
<AndroidEnableProfiledAot>true</AndroidEnableProfiledAot>
```

**iOS (Release builds):**
```xml
<MtouchInterpreter>-all</MtouchInterpreter>
<EnableSGenConc>True</EnableSGenConc>
```

**Custom AOT Profile for Android:**
```powershell
# Create a custom AOT profile for better performance
dotnet add package Mono.AotProfiler.Android
dotnet build -t:BuildAndStartAotProfiling -f net10.0-android -p:UseInterpreter=false
# Use the app for a while to collect profile data
dotnet build -t:FinishAotProfiling -f net10.0-android
dotnet remove package Mono.AotProfiler.Android
```

## Application Configuration

### ClientMauiSettings

The MAUI app has specific configuration in [`ClientMauiSettings.cs`](/src/Client/Boilerplate.Client.Maui/ClientMauiSettings.cs):

```csharp
public class ClientMauiSettings : ClientCoreSettings
{
    /// <summary>
    /// When the MAUI app sends a request to the API server, and the API server 
    /// and web app are hosted on different URLs, the origin of the generated links 
    /// (e.g., email confirmation links) will depend on `WebAppUrl` value.
    /// </summary>
    public Uri? WebAppUrl { get; set; }
}
```

**[`appsettings.json`](/src/Client/Boilerplate.Client.Maui/appsettings.json):**
```json
{
    "WebAppUrl": null
}
```

**Use case**: If your API server is at `https://api.example.com` but your web app is at `https://www.example.com`, set `WebAppUrl` to `https://www.example.com` so email links point to the web app, not the API server.

## Resources and Assets

The `Resources/` folder contains all visual assets:

### App Icon
- **Location**: `Resources/AppIcon/appicon.svg`
- **Configuration**:
```xml
<!-- App icon for all platforms -->
<MauiIcon Include="Resources\AppIcon\appicon.svg" Color="#0065EF" />

<!-- Customize for Android -->
<MauiIcon Condition="$(TargetFramework.Contains('-android'))" 
    Update="Resources\AppIcon\appicon.svg" 
    Color="#0065EF" 
    ForegroundScale="0.68" />
```

### Splash Screen
- **Location**: `Resources/Splash/splash.svg`
- **Configuration**:
```xml
<MauiSplashScreen Include="Resources\Splash\splash.svg" 
    Color="#0D2960" 
    BaseSize="128,128" />
```

### Images, Fonts, and Raw Assets
```xml
<MauiImage Include="Resources\Images\*" />
<MauiFont Include="Resources\Fonts\*" />
<MauiAsset Include="Resources\Raw\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />
```

**Important**: MAUI automatically handles image density scaling across platforms. Just provide SVG or high-resolution PNG files.

## Key Differences Between Web and MAUI

| Aspect | Blazor Web (WASM) | MAUI Blazor Hybrid |
|--------|-------------------|---------------------|
| **Rendering** | Runs in browser's WASM runtime | Runs in native .NET runtime, renders in WebView |
| **Performance** | Limited by browser sandbox | Full native performance |
| **File Access** | Very limited (browser sandbox) | Full file system access |
| **Device Features** | Limited (WebAPIs only) | Full access to all native APIs |
| **Offline** | Requires service worker | Native offline support |
| **Distribution** | Web hosting | App stores |
| **Updates** | Instant (refresh page) | Through app stores (or force update system) |
| **Startup Time** | Download + parse WASM | Instant (native) |
| **Package Size** | Downloaded on demand | Installed upfront (larger) |

## Best Practices

### 1. Always Check Platform Availability

```csharp
if (AppPlatform.IsBlazorHybrid)
{
    // MAUI-specific code
    await Preferences.SetAsync("key", "value");
}
else
{
    // Web-specific code
    await localStorage.setItem("key", "value");
}
```

### 2. Use Dependency Injection for Platform Abstraction

Don't check the platform directly in your components. Instead, use interfaces:

```csharp
// In your component
@inject IStorageService StorageService

// Works on both web and MAUI
await StorageService.SetItem("key", "value");
```

### 3. Handle Deep Links Gracefully

```csharp
protected override async Task OnInitAsync()
{
    // Subscribe to deep link navigation
    PubSubService.Subscribe(ClientPubSubMessages.DEEP_LINK_RECEIVED, async args =>
    {
        var url = (string)args!;
        await OnDeepLinkReceived(url);
    });
}
```

### 4. Test on Real Devices

Emulators are useful, but always test on real devices before release:
- **Android**: Test on various manufacturers (Samsung, Google Pixel, etc.)
- **iOS**: Test on different iPhone models and iOS versions
- **Windows**: Test on different Windows versions (10, 11)

### 5. Monitor WebView Console

In development, enable WebView developer tools:

```csharp
services.AddBlazorWebViewDeveloperTools();
```

On iOS/Mac, you can inspect the WebView using Safari's Web Inspector.
On Android, use Chrome DevTools: `chrome://inspect`
On Windows, use Edge DevTools.

## Common Challenges and Solutions

### 1. "File Not Found" Errors

**Problem**: Static files not loading in MAUI app.

**Solution**: Ensure files are included as `MauiAsset`:
```xml
<MauiAsset Include="wwwroot\**" LogicalName="%(RecursiveDir)%(Filename)%(Extension)" />
```

### 2. JavaScript Interop Not Working

**Problem**: `JSRuntime` calls fail in MAUI.

**Solution**: Wait for the BlazorWebView to be ready:
```csharp
protected override async Task OnAfterFirstRenderAsync()
{
    // Now safe to call JS interop
    await JSRuntime.InvokeVoidAsync("myFunction");
}
```

### 3. Different Behavior on Different Platforms

**Problem**: Feature works on Android but not iOS.

**Solution**: Use platform-specific implementations:
```csharp
public partial class MauiFeatureService
{
#if Android
    public void DoSomething() { /* Android implementation */ }
#elif iOS
    public void DoSomething() { /* iOS implementation */ }
#endif
}
```

### 3. Obfuscation and Code Protection

For production builds, consider:
- **Android**: ProGuard/R8 for code obfuscation (already enabled in release mode)
- **iOS**: Bitcode for optimization
- **All platforms**: Remove debug symbols and unused code

## Deployment

### Android

1. **Create a signed APK/AAB:**
```powershell
dotnet publish -f net10.0-android -c Release -p:AndroidPackageFormat=aab
```

2. **Upload to Google Play Console**

3. **Important**: Update `ApplicationId` in `.csproj`:
```xml
<ApplicationId>com.yourcompany.yourapp</ApplicationId>
```

### iOS

1. **Create an archive:**
```powershell
dotnet publish -f net10.0-ios -c Release
```

2. **Upload to App Store Connect** (requires macOS and Xcode)

3. **Important**: Update bundle identifier in `Info.plist`

### Windows

1. **Create MSIX package:**
```powershell
dotnet publish -f net10.0-windows10.0.19041.0 -c Release
```

2. **Submit to Microsoft Store** or distribute via sideloading

## Helpful Resources

- **.NET MAUI Documentation**: https://learn.microsoft.com/dotnet/maui/
- **Blazor Hybrid Documentation**: https://learn.microsoft.com/aspnet/core/blazor/hybrid/
- **Platform-Specific Features**: https://learn.microsoft.com/dotnet/maui/platform-integration/
- **MAUI Community Toolkit**: https://learn.microsoft.com/dotnet/communitytoolkit/maui/

---

## Summary

In this stage, you learned:

✅ **Native Platform Benefits**: Better performance, wider user reach, and full native OS capabilities  
✅ **Deep Links & Universal Links**: How to make web URLs open directly in your native app  
✅ **Application Versioning**: How version numbers work for mobile app stores  
✅ **Windows Project Advantages**: Why `Boilerplate.Client.Windows` offers better Windows support  
✅ **App Size Optimization**: Best practices for keeping your app size reasonable  
✅ **WebView Importance**: Understanding the critical role of WebView versions  
✅ **Project Structure**: The organization of the MAUI project and platform-specific code  
✅ **Platform Services**: How to implement platform-specific features  
✅ **Code Reuse**: Sharing 90%+ of your code between web and native apps  
✅ **Native Features**: Push notifications, deep linking, storage, and more  
✅ **Performance Optimizations**: AOT compilation and platform-specific tweaks  
✅ **Deployment**: Building and publishing to app stores  

The MAUI Blazor Hybrid approach gives you the **best of both worlds**: the productivity of web development with the power of native applications!

### Additional Resources

- **Bitplatform Templates**: https://bitplatform.dev/templates - Platform support and getting started
- **Bitplatform Demos**: https://bitplatform.dev/demos - Live examples and app size reference
- **.NET MAUI Documentation**: https://learn.microsoft.com/dotnet/maui/
- **Blazor Hybrid Documentation**: https://learn.microsoft.com/aspnet/core/blazor/hybrid/
- **Platform-Specific Features**: https://learn.microsoft.com/dotnet/maui/platform-integration/
- **MAUI Community Toolkit**: https://learn.microsoft.com/dotnet/communitytoolkit/maui/

---