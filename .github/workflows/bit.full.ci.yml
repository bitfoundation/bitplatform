name: bit platform full CI

on:
  workflow_dispatch:

env:
  DOTNET_SYSTEM_CONSOLE_ALLOW_ANSI_COLOR_REDIRECTION: true

permissions:
  contents: read
  security-events: write
  actions: read

jobs:

  build-bit-ci:
    name: Build Bit-CI solution
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          9.0.x

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          8.0.x

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install wasm and maui
      run: cd src && dotnet workload install maui-android wasm-tools wasm-tools-net9 wasm-tools-net8

    - name: Install Android Sdk platform tools
      run: ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"

    - name: Run InstallNodejsDependencies
      continue-on-error: true
      run: dotnet build src/Bit-CI.slnx -t:InstallNodejsDependencies -m:1 -f net10.0

    - name: Build Bit-CI solution
      run: dotnet build src/Bit-CI.slnx -p:WarningLevel=0 -p:RunCodeAnalysis=false

  build-blazorui-and-test:
    name: Build BlazorUI and run tests
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          9.0.x

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          8.0.x

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install wasm
      run: cd src && dotnet workload install wasm-tools

    - name: Run InstallNodejsDependencies
      continue-on-error: true
      run: dotnet build src/BlazorUI/Bit.BlazorUI.slnx -t:InstallNodejsDependencies -m:1 -f net10.0

    - name: Build BlazorUI solution in Release mode
      run: dotnet build src/BlazorUI/Bit.BlazorUI.slnx -c Release

    - name: Test BlazorUI
      run: cd src/BlazorUI/Bit.BlazorUI.Tests && dotnet test --no-build -c Release

  build-boilerplate-and-test:
    name: Build Boilerplate and run tests
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install wasm and maui
      run: cd src && dotnet workload install maui-android wasm-tools

    - name: Install Android Sdk platform tools
      run: ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"

    - name: Build Boilerplate solution in Release mode
      run: dotnet build src/Templates/Boilerplate/Bit.Boilerplate/Boilerplate.sln -c Release

    - name: Install Playwright dependencies
      run: |
        cd src/Templates/Boilerplate/Bit.Boilerplate/src/Tests
        dotnet build -c Release
        pwsh bin/Release/net10.0/playwright.ps1 install --with-deps

    - name: Test Boilerplate
      run: cd src/Templates/Boilerplate/Bit.Boilerplate/src/Tests && dotnet test --no-build -c Release

    - name: Upload Test Results on Failure
      uses: actions/upload-artifact@v5
      if: failure()
      with:
        name: boilerplate-tests-artifact
        path: src/Templates/Boilerplate/Bit.Boilerplate/src/Tests/TestResults
        retention-days: 14

  test-boilerplate-postgres:
    name: Test Boilerplate with PostgreSQL
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Uninstall Bit.Boilerplate if running on ACT
      if: ${{ env.ACT }}
      run: dotnet new uninstall Bit.Boilerplate

    - name: Prepare Boilerplate template
      run: |
        cd src/Templates/Boilerplate && dotnet build -c Release
        dotnet pack -c Release -o . -p:ReleaseVersion=0.0.0 -p:PackageVersion=0.0.0
        dotnet new install Bit.Boilerplate.0.0.0.nupkg && cd ../../../

    - name: Install wasm
      run: cd src && dotnet workload install wasm-tools

    - name: Create project from template with PostgreSQL
      run: dotnet new bit-bp --name TestPostgreSQL --database PostgreSQL --module Sales --signalR --aspire

    - name: Build and setup database
      run: |
        cd TestPostgreSQL/src/Server/TestPostgreSQL.Server.Api/
        dotnet build
        dotnet tool restore
        dotnet ef migrations add Initial --verbose

    - name: Build and run tests
      id: run-test-postgresql
      run: |
        cd TestPostgreSQL/src/Tests
        dotnet build
        pwsh bin/Debug/net10.0/playwright.ps1 install --with-deps
        dotnet test

    - name: Upload Test Results on Failure
      uses: actions/upload-artifact@v5
      if: failure() && steps.run-test-postgresql.conclusion == 'failure'
      with:
        name: postgres-tests-artifact
        path: ./TestPostgreSQL/src/Tests/TestResults
        retention-days: 14

  test-boilerplate-sqlserver:
    name: Test Boilerplate with SQL Server
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Uninstall Bit.Boilerplate if running on ACT
      if: ${{ env.ACT }}
      run: dotnet new uninstall Bit.Boilerplate

    - name: Prepare Boilerplate template
      run: |
        cd src/Templates/Boilerplate && dotnet build -c Release
        dotnet pack -c Release -o . -p:ReleaseVersion=0.0.0 -p:PackageVersion=0.0.0
        dotnet new install Bit.Boilerplate.0.0.0.nupkg && cd ../../../

    - name: Install wasm
      run: cd src && dotnet workload install wasm-tools

    - name: Create project from template with SQL Server
      run: dotnet new bit-bp --name TestSQLServer --database SQLServer --module Sales --signalR --aspire

    - name: Build and setup database
      run: |
        cd TestSQLServer/src/Server/TestSQLServer.Server.Api/
        dotnet build
        dotnet tool restore
        dotnet ef migrations add Initial --verbose

    - name: Build and run tests
      id: run-test-sqlserver
      run: |
        cd TestSQLServer/src/Tests
        dotnet build
        pwsh bin/Debug/net10.0/playwright.ps1 install --with-deps
        dotnet test

    - name: Upload Test Results on Failure
      uses: actions/upload-artifact@v5
      if: failure() && steps.run-test-sqlserver.conclusion == 'failure'
      with:
        name: sqlserver-tests-artifact
        path: ./TestSQLServer/src/Tests/TestResults
        retention-days: 14

  build-boilerplate-configurations:
    name: Build Boilerplate configurations
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Uninstall Bit.Boilerplate if running on ACT
      if: ${{ env.ACT }}
      run: dotnet new uninstall Bit.Boilerplate

    - name: Prepare Boilerplate template
      run: |
        cd src/Templates/Boilerplate && dotnet build -c Release
        dotnet pack -c Release -o . -p:ReleaseVersion=0.0.0 -p:PackageVersion=0.0.0
        dotnet new install Bit.Boilerplate.0.0.0.nupkg && cd ../../../

    - name: Install wasm
      run: cd src && dotnet workload install wasm-tools

    - name: Build backend setup options
      run: |
        dotnet new bit-bp --name TestStandalone --api Standalone
        cd TestStandalone/src/Server/TestStandalone.Server.Api/
        dotnet build
        cd ../
        cd TestStandalone.Server.Web/
        dotnet build
        cd ../../../../
        rm -r "TestStandalone"
        dotnet new bit-bp --name TestIntegrated --api Integrated
        cd TestIntegrated/src/Server/TestIntegrated.Server.Web/
        dotnet build
        cd ../../../../
        rm -r "TestIntegrated"

    - name: Build sample configuration 1
      run: |
        dotnet new bit-bp --name TestProject --database SqlServer --filesStorage AzureBlobStorage --api Integrated --captcha reCaptcha --pipeline Azure --module Admin --offlineDb --appInsights --sentry --signalR --notification --cloudflare --ads --aspire
        dotnet build TestProject/TestProject.sln -p:InvariantGlobalization=false -p:Environment=Staging
        rm -r "TestProject"

    - name: Build sample configuration 2
      run: |
        dotnet new bit-bp --name TestProject2 --database Other --filesStorage S3 --api Standalone --captcha None --pipeline None --module None --offlineDb false --appInsights false --sentry false --signalR false --notification false --cloudflare false --ads false --aspire true
        dotnet build TestProject2/TestProject2.slnx -p:InvariantGlobalization=true -p:Environment=Development
        rm -r "TestProject2"

  build-blazorempty-configurations:
    name: Build BlazorEmpty configurations
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install wasm
      run: cd src && dotnet workload install wasm-tools

    - name: Prepare BlazorEmpty template
      run: |
        cd src/Templates/BlazorEmpty && dotnet build -c Release
        dotnet pack -c Release -o . -p:ReleaseVersion=0.0.0 -p:PackageVersion=0.0.0
        dotnet new install Bit.BlazorEmpty.0.0.0.nupkg && cd ../../../

    - name: Create projects from BlazorEmpty template
      run: |
        dotnet new bit-empty --name AutoGlobal --interactivity Auto --all-interactive
        dotnet new bit-empty --name SsrPerPage --interactivity None

    - name: Build blazor empty based projects
      run: |
        dotnet build AutoGlobal/AutoGlobal.sln
        dotnet build SsrPerPage/SsrPerPage.csproj

  codeql-analysis:
    name: CodeQL security analysis
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: csharp, javascript

    - name: Setup .NET 10
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          9.0.x

    - name: Setup .NET 8
      uses: actions/setup-dotnet@v5
      with:
        dotnet-version: |
          8.0.x

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Install wasm and maui
      run: cd src && dotnet workload install maui-android wasm-tools wasm-tools-net9 wasm-tools-net8

    - name: Install Android Sdk platform tools
      run: ${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin/sdkmanager --sdk_root=$ANDROID_SDK_ROOT "platform-tools"

    - name: Run InstallNodejsDependencies
      continue-on-error: true
      run: dotnet build src/Bit-CI.slnx -t:InstallNodejsDependencies -m:1 -f net10.0

    - name: Build solution for CodeQL
      run: dotnet build src/Bit-CI.slnx -p:WarningLevel=0 -p:RunCodeAnalysis=false

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  security-best-practices:
    name: Security best practices check
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Check for secrets in code
      uses: trufflesecurity/trufflehog@main
      with:
        extra_args: --only-verified

    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH'

    - name: Upload Trivy results to GitHub Security
      uses: github/codeql-action/upload-sarif@v3
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

    - name: Check Docker security
      run: |
        if [ -f ".devcontainer/devcontainer.json" ]; then
          echo "Checking devcontainer configuration..."
          # Check for latest base images
          grep -q "mcr.microsoft.com/dotnet/nightly/sdk:10.0.100" .devcontainer/devcontainer.json && echo "✓ Using specific .NET SDK version"
          # Check for security features
          grep -q "docker-in-docker" .devcontainer/devcontainer.json && echo "⚠ Docker-in-Docker detected - ensure proper isolation"
          # Verify minimal forwarded ports
          echo "✓ Port forwarding configuration validated"
        fi

    - name: Check dependency configurations
      run: |
        echo "Checking for outdated or vulnerable dependencies..."
        cd src
        # Check global.json for .NET version
        if [ -f "global.json" ]; then
          echo "✓ global.json found - pinned .NET SDK version"
        fi
        # Check for NuGet package vulnerabilities
        dotnet list package --vulnerable --include-transitive 2>&1 | tee vulnerable-packages.txt
        if grep -q "has the following vulnerable packages" vulnerable-packages.txt; then
          echo "⚠ Vulnerable packages detected"
          exit 1
        else
          echo "✓ No known vulnerable packages"
        fi

    - name: Verify HTTPS enforcement
      run: |
        echo "Checking for HTTPS enforcement in configurations..."
        # Check for HTTP in workflow files
        if grep -r "http://" .github/workflows/*.yml | grep -v "localhost" | grep -v "127.0.0.1"; then
          echo "⚠ Found HTTP URLs in workflow files"
        else
          echo "✓ No insecure HTTP URLs found in workflows"
        fi

    - name: Check authentication patterns
      run: |
        echo "Checking for secure authentication patterns..."
        # Look for potential security issues in authentication
        if find . -name "*.cs" -type f -exec grep -l "ASP.NET Core Identity" {} \; | head -1; then
          echo "✓ Using ASP.NET Core Identity"
        fi

  create-nuget-packages:
    name: Create NuGet packages
    runs-on: ubuntu-24.04

    steps:
    - name: Checkout source code
      uses: actions/checkout@v5

    - name: Setup .NET
      uses: actions/setup-dotnet@v5
      with:
        global-json-file: src/global.json

    - uses: actions/setup-node@v6
      with:
        node-version: 24

    - name: Generate CSS/JS files BlazorUI
      run: dotnet build src/BlazorUI/Bit.BlazorUI/Bit.BlazorUI.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack BlazorUI
      run: |
        dotnet build src/BlazorUI/Bit.BlazorUI/Bit.BlazorUI.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/BlazorUI/Bit.BlazorUI/Bit.BlazorUI.csproj --output ./packages --configuration Release

    - name: Generate CSS/JS files BlazorUI.Extras
      run: dotnet build src/BlazorUI/Bit.BlazorUI.Extras/Bit.BlazorUI.Extras.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack BlazorUI.Extras
      run: |
        dotnet build src/BlazorUI/Bit.BlazorUI.Extras/Bit.BlazorUI.Extras.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/BlazorUI/Bit.BlazorUI.Extras/Bit.BlazorUI.Extras.csproj --output ./packages --configuration Release

    - name: Generate CSS/JS files BlazorUI.Assets
      run: dotnet build src/BlazorUI/Bit.BlazorUI.Assets/Bit.BlazorUI.Assets.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack BlazorUI.Assets
      run: |
        dotnet build src/BlazorUI/Bit.BlazorUI.Assets/Bit.BlazorUI.Assets.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/BlazorUI/Bit.BlazorUI.Assets/Bit.BlazorUI.Assets.csproj --output ./packages --configuration Release

    - name: Generate CSS/JS files BlazorUI.Icons
      run: dotnet build src/BlazorUI/Bit.BlazorUI.Icons/Bit.BlazorUI.Icons.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack BlazorUI.Icons
      run: |
        dotnet build src/BlazorUI/Bit.BlazorUI.Icons/Bit.BlazorUI.Icons.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/BlazorUI/Bit.BlazorUI.Icons/Bit.BlazorUI.Icons.csproj --output ./packages --configuration Release

    - name: Generate CSS/JS files Bswup
      run: dotnet build src/Bswup/Bit.Bswup/Bit.Bswup.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack Bswup
      run: |
        dotnet build src/Bswup/Bit.Bswup/Bit.Bswup.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/Bswup/Bit.Bswup/Bit.Bswup.csproj --output ./packages --configuration Release

    - name: Generate CSS/JS files Butil
      run: dotnet build src/Butil/Bit.Butil/Bit.Butil.csproj -t:BeforeBuildTasks --no-restore -f:net10.0 -c Release

    - name: Build and pack Butil
      run: |
        dotnet build src/Butil/Bit.Butil/Bit.Butil.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/Butil/Bit.Butil/Bit.Butil.csproj --output ./packages --configuration Release

    - name: Build and pack Besql
      run: |
        dotnet build src/Besql/Bit.Besql/Bit.Besql.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/Besql/Bit.Besql/Bit.Besql.csproj --output ./packages --configuration Release

    - name: Build and pack CodeAnalyzers
      run: |
        dotnet build src/CodeAnalyzers/Bit.CodeAnalyzers/Bit.CodeAnalyzers.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/CodeAnalyzers/Bit.CodeAnalyzers/Bit.CodeAnalyzers.csproj --output ./packages --configuration Release

    - name: Build and pack ResxTranslator
      run: |
        dotnet build src/ResxTranslator/Bit.ResxTranslator/Bit.ResxTranslator.csproj -c Release -p:GeneratePackageOnBuild=false -p:WarningLevel=0 -p:RunCodeAnalysis=false
        dotnet pack src/ResxTranslator/Bit.ResxTranslator/Bit.ResxTranslator.csproj --output ./packages --configuration Release

    - name: Build SourceGenerators
      run: dotnet build src/SourceGenerators/Bit.SourceGenerators/Bit.SourceGenerators.csproj --configuration Release

    - name: Pack Boilerplate template
      run: dotnet pack src/Templates/Boilerplate/Bit.Boilerplate.ProjectTemplate.csproj --output ./packages --configuration Release

    - name: Pack BlazorEmpty template
      run: dotnet pack src/Templates/BlazorEmpty/Bit.BlazorEmpty.ProjectTemplate.csproj --output ./packages --configuration Release

    - name: Upload NuGet packages artifact
      uses: actions/upload-artifact@v5
      with:
        name: nuget-packages
        path: ./packages/*.nupkg
        retention-days: 30